-- PostgreSQL Schema Template
-- {{description}}
-- Generated by AgenticCoder

-- Enable extensions
{{#if extensions}}
{{#each extensions}}
CREATE EXTENSION IF NOT EXISTS "{{this}}";
{{/each}}
{{/if}}

{{#each tables}}
-- Table: {{name}}
-- {{description}}
CREATE TABLE IF NOT EXISTS {{snakeCase name}} (
    -- Primary Key
    id {{#if useUUID}}UUID DEFAULT gen_random_uuid(){{else}}SERIAL{{/if}} PRIMARY KEY,
    
    {{#each columns}}
    -- {{description}}
    {{snakeCase name}} {{sqlType}}{{#if notNull}} NOT NULL{{/if}}{{#if unique}} UNIQUE{{/if}}{{#if default}} DEFAULT {{default}}{{/if}}{{#if check}} CHECK ({{check}}){{/if}},
    {{/each}}
    
    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL{{#if softDelete}},
    deleted_at TIMESTAMP WITH TIME ZONE{{/if}}
    
    {{#if foreignKeys}}
    {{#each foreignKeys}}
    ,CONSTRAINT fk_{{../snakeCase ../name}}_{{snakeCase column}}
        FOREIGN KEY ({{snakeCase column}})
        REFERENCES {{snakeCase refTable}} ({{snakeCase refColumn}})
        ON DELETE {{onDelete}}
        ON UPDATE {{onUpdate}}
    {{/each}}
    {{/if}}
);

{{#if indexes}}
-- Indexes for {{name}}
{{#each indexes}}
CREATE {{#if unique}}UNIQUE {{/if}}INDEX {{#if concurrently}}CONCURRENTLY {{/if}}IF NOT EXISTS idx_{{../snakeCase ../name}}_{{snakeCase name}}
    ON {{../snakeCase ../name}} {{#if using}}USING {{using}} {{/if}}({{columns}}){{#if where}} WHERE {{where}}{{/if}};
{{/each}}
{{/if}}

-- Update timestamp trigger for {{name}}
CREATE OR REPLACE TRIGGER update_{{snakeCase name}}_updated_at
    BEFORE UPDATE ON {{snakeCase name}}
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

{{/each}}

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

{{#if views}}
-- Views
{{#each views}}
CREATE OR REPLACE VIEW {{snakeCase name}} AS
{{query}};
{{/each}}
{{/if}}

{{#if functions}}
-- Functions
{{#each functions}}
CREATE OR REPLACE FUNCTION {{snakeCase name}}({{params}})
RETURNS {{returnType}} AS $$
{{body}}
$$ LANGUAGE {{language}};
{{/each}}
{{/if}}
