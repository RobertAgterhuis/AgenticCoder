-- PostgreSQL Migration Template
-- Migration: {{name}}
-- Description: {{description}}
-- Created: {{timestamp}}
-- Generated by AgenticCoder

-- ============================================
-- UP MIGRATION
-- ============================================

{{#if createTables}}
-- Create new tables
{{#each createTables}}
CREATE TABLE IF NOT EXISTS {{snakeCase name}} (
    id {{#if useUUID}}UUID DEFAULT gen_random_uuid(){{else}}SERIAL{{/if}} PRIMARY KEY,
    {{#each columns}}
    {{snakeCase name}} {{sqlType}}{{#if notNull}} NOT NULL{{/if}}{{#if default}} DEFAULT {{default}}{{/if}},
    {{/each}}
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

{{/each}}
{{/if}}

{{#if alterTables}}
-- Alter existing tables
{{#each alterTables}}
{{#if addColumns}}
{{#each addColumns}}
ALTER TABLE {{../snakeCase ../table}} 
    ADD COLUMN IF NOT EXISTS {{snakeCase name}} {{sqlType}}{{#if notNull}} NOT NULL{{/if}}{{#if default}} DEFAULT {{default}}{{/if}};
{{/each}}
{{/if}}

{{#if dropColumns}}
{{#each dropColumns}}
ALTER TABLE {{../snakeCase ../table}} 
    DROP COLUMN IF EXISTS {{snakeCase name}};
{{/each}}
{{/if}}

{{#if modifyColumns}}
{{#each modifyColumns}}
ALTER TABLE {{../snakeCase ../table}} 
    ALTER COLUMN {{snakeCase name}} TYPE {{newType}}{{#if using}} USING {{using}}{{/if}};
{{#if setNotNull}}
ALTER TABLE {{../snakeCase ../table}} 
    ALTER COLUMN {{snakeCase name}} SET NOT NULL;
{{/if}}
{{#if dropNotNull}}
ALTER TABLE {{../snakeCase ../table}} 
    ALTER COLUMN {{snakeCase name}} DROP NOT NULL;
{{/if}}
{{/each}}
{{/if}}

{{#if addConstraints}}
{{#each addConstraints}}
ALTER TABLE {{../snakeCase ../table}}
    ADD CONSTRAINT {{name}} {{definition}};
{{/each}}
{{/if}}

{{/each}}
{{/if}}

{{#if createIndexes}}
-- Create indexes
{{#each createIndexes}}
CREATE {{#if unique}}UNIQUE {{/if}}INDEX {{#if concurrently}}CONCURRENTLY {{/if}}IF NOT EXISTS {{name}}
    ON {{snakeCase table}} ({{columns}});
{{/each}}
{{/if}}

{{#if dataMigration}}
-- Data migration
{{dataMigration}}
{{/if}}

-- ============================================
-- DOWN MIGRATION (Rollback)
-- ============================================

{{#if rollback}}
{{rollback}}
{{else}}
-- Auto-generated rollback
{{#if createIndexes}}
{{#each createIndexes}}
-- DROP INDEX IF EXISTS {{name}};
{{/each}}
{{/if}}

{{#if createTables}}
{{#each createTables}}
-- DROP TABLE IF EXISTS {{snakeCase name}} CASCADE;
{{/each}}
{{/if}}
{{/if}}
