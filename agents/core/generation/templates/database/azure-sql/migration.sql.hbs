-- Azure SQL Migration Template
-- Migration: {{name}}
-- Version: {{version}}
-- Description: {{description}}
-- Generated by AgenticCoder

SET XACT_ABORT ON;
GO

BEGIN TRANSACTION;
GO

-- Migration version tracking
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[__MigrationHistory]') AND type in (N'U'))
BEGIN
    CREATE TABLE [dbo].[__MigrationHistory] (
        [MigrationId] NVARCHAR(150) NOT NULL,
        [AppliedAt] DATETIME2 DEFAULT GETUTCDATE() NOT NULL,
        [Description] NVARCHAR(500) NULL,
        CONSTRAINT [PK_MigrationHistory] PRIMARY KEY CLUSTERED ([MigrationId] ASC)
    );
END
GO

-- Check if migration already applied
IF EXISTS (SELECT 1 FROM [dbo].[__MigrationHistory] WHERE [MigrationId] = '{{version}}')
BEGIN
    PRINT 'Migration {{version}} already applied. Skipping...';
    ROLLBACK TRANSACTION;
    RETURN;
END
GO

PRINT 'Applying migration: {{version}} - {{name}}';
GO

{{#if createTables}}
-- Create new tables
{{#each createTables}}
CREATE TABLE [dbo].[{{pascalCase name}}] (
    [Id] {{#if useGuid}}UNIQUEIDENTIFIER DEFAULT NEWID(){{else}}INT IDENTITY(1,1){{/if}} NOT NULL,
    {{#each columns}}
    [{{pascalCase name}}] {{sqlType}}{{#if notNull}} NOT NULL{{/if}}{{#if default}} DEFAULT {{default}}{{/if}},
    {{/each}}
    [CreatedAt] DATETIME2 DEFAULT GETUTCDATE() NOT NULL,
    [UpdatedAt] DATETIME2 DEFAULT GETUTCDATE() NOT NULL,
    CONSTRAINT [PK_{{pascalCase name}}] PRIMARY KEY CLUSTERED ([Id] ASC)
);
GO
{{/each}}
{{/if}}

{{#if alterTables}}
-- Alter existing tables
{{#each alterTables}}
{{#if addColumns}}
{{#each addColumns}}
ALTER TABLE [dbo].[{{../pascalCase ../table}}]
    ADD [{{pascalCase name}}] {{sqlType}}{{#if notNull}} NOT NULL{{/if}}{{#if default}} DEFAULT {{default}}{{/if}};
GO
{{/each}}
{{/if}}

{{#if dropColumns}}
{{#each dropColumns}}
ALTER TABLE [dbo].[{{../pascalCase ../table}}]
    DROP COLUMN [{{pascalCase name}}];
GO
{{/each}}
{{/if}}
{{/each}}
{{/if}}

{{#if dataMigration}}
-- Data migration
{{dataMigration}}
GO
{{/if}}

-- Record migration
INSERT INTO [dbo].[__MigrationHistory] ([MigrationId], [Description])
VALUES ('{{version}}', '{{description}}');
GO

COMMIT TRANSACTION;
GO

PRINT 'Migration {{version}} completed successfully.';
GO
