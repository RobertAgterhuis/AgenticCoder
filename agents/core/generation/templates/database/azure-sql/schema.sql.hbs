-- Azure SQL Schema Template
-- {{description}}
-- Generated by AgenticCoder

{{#each tables}}
-- Table: {{name}}
-- {{description}}
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[{{pascalCase name}}]') AND type in (N'U'))
BEGIN
    CREATE TABLE [dbo].[{{pascalCase name}}] (
        -- Primary Key
        [Id] {{#if useGuid}}UNIQUEIDENTIFIER DEFAULT NEWID(){{else}}INT IDENTITY(1,1){{/if}} NOT NULL,
        
        {{#each columns}}
        -- {{description}}
        [{{pascalCase name}}] {{sqlType}}{{#if notNull}} NOT NULL{{/if}}{{#if default}} DEFAULT {{default}}{{/if}},
        {{/each}}
        
        -- Timestamps
        [CreatedAt] DATETIME2 DEFAULT GETUTCDATE() NOT NULL,
        [UpdatedAt] DATETIME2 DEFAULT GETUTCDATE() NOT NULL,
        {{#if softDelete}}
        [DeletedAt] DATETIME2 NULL,
        {{/if}}
        
        -- Constraints
        CONSTRAINT [PK_{{pascalCase name}}] PRIMARY KEY CLUSTERED ([Id] ASC)
        {{#if foreignKeys}}
        {{#each foreignKeys}}
        ,CONSTRAINT [FK_{{../pascalCase ../name}}_{{pascalCase column}}]
            FOREIGN KEY ([{{pascalCase column}}])
            REFERENCES [dbo].[{{pascalCase refTable}}] ([{{pascalCase refColumn}}])
            ON DELETE {{onDelete}}
            ON UPDATE {{onUpdate}}
        {{/each}}
        {{/if}}
    );
END
GO

{{#if indexes}}
-- Indexes for {{name}}
{{#each indexes}}
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_{{../pascalCase ../name}}_{{name}}' AND object_id = OBJECT_ID('[dbo].[{{../pascalCase ../name}}]'))
BEGIN
    CREATE {{#if unique}}UNIQUE {{/if}}{{#if type}}{{type}} {{/if}}INDEX [IX_{{../pascalCase ../name}}_{{name}}]
    ON [dbo].[{{../pascalCase ../name}}] ({{columns}})
    {{#if include}}INCLUDE ({{include}}){{/if}}
    {{#if where}}WHERE {{where}}{{/if}};
END
GO
{{/each}}
{{/if}}

{{/each}}

-- Trigger for UpdatedAt timestamp
{{#each tables}}
IF EXISTS (SELECT * FROM sys.triggers WHERE name = 'TR_{{pascalCase name}}_UpdatedAt')
    DROP TRIGGER [TR_{{pascalCase name}}_UpdatedAt];
GO

CREATE TRIGGER [TR_{{pascalCase name}}_UpdatedAt]
ON [dbo].[{{pascalCase name}}]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE [dbo].[{{pascalCase name}}]
    SET [UpdatedAt] = GETUTCDATE()
    FROM [dbo].[{{pascalCase name}}] t
    INNER JOIN inserted i ON t.[Id] = i.[Id];
END
GO

{{/each}}
