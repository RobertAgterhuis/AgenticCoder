# API Gateway Configuration Template: {{projectName}}
# {{description}}
# Generated by AgenticCoder

{{#if useKong}}
# Kong API Gateway Configuration
_format_version: "3.0"
_transform: true

services:
  {{#each services}}
  - name: {{kebabCase name}}-service
    url: {{url}}
    {{#if retries}}
    retries: {{retries}}
    {{/if}}
    {{#if connectTimeout}}
    connect_timeout: {{connectTimeout}}
    {{/if}}
    {{#if writeTimeout}}
    write_timeout: {{writeTimeout}}
    {{/if}}
    {{#if readTimeout}}
    read_timeout: {{readTimeout}}
    {{/if}}
    routes:
      {{#each routes}}
      - name: {{kebabCase ../name}}-{{kebabCase name}}-route
        {{#if paths}}
        paths:
          {{#each paths}}
          - {{this}}
          {{/each}}
        {{/if}}
        {{#if methods}}
        methods:
          {{#each methods}}
          - {{this}}
          {{/each}}
        {{/if}}
        {{#if hosts}}
        hosts:
          {{#each hosts}}
          - {{this}}
          {{/each}}
        {{/if}}
        {{#if stripPath}}
        strip_path: {{stripPath}}
        {{/if}}
        {{#if preserveHost}}
        preserve_host: {{preserveHost}}
        {{/if}}
      {{/each}}
    {{#if plugins}}
    plugins:
      {{#each plugins}}
      - name: {{name}}
        {{#if config}}
        config:
          {{#each config}}
          {{key}}: {{value}}
          {{/each}}
        {{/if}}
      {{/each}}
    {{/if}}
  {{/each}}

{{#if globalPlugins}}
plugins:
  {{#each globalPlugins}}
  - name: {{name}}
    {{#if config}}
    config:
      {{#each config}}
      {{key}}: {{value}}
      {{/each}}
    {{/if}}
  {{/each}}
{{/if}}

{{#if consumers}}
consumers:
  {{#each consumers}}
  - username: {{username}}
    {{#if customId}}
    custom_id: {{customId}}
    {{/if}}
    {{#if keyAuth}}
    keyauth_credentials:
      - key: {{keyAuth.key}}
    {{/if}}
    {{#if jwt}}
    jwt_secrets:
      - key: {{jwt.key}}
        secret: {{jwt.secret}}
    {{/if}}
  {{/each}}
{{/if}}

{{else}}
# NGINX API Gateway Configuration
{{#if useNginx}}
upstream_servers:
  {{#each services}}
  {{kebabCase name}}:
    servers:
      {{#each upstreams}}
      - address: {{address}}
        {{#if weight}}
        weight: {{weight}}
        {{/if}}
      {{/each}}
    {{#if healthCheck}}
    health_check:
      interval: {{healthCheck.interval}}
      timeout: {{healthCheck.timeout}}
      unhealthy_threshold: {{healthCheck.unhealthyThreshold}}
    {{/if}}
  {{/each}}

routes:
  {{#each services}}
  {{#each routes}}
  - location: {{path}}
    proxy_pass: http://{{../kebabCase ../name}}
    {{#if rewrite}}
    rewrite: {{rewrite}}
    {{/if}}
    {{#if headers}}
    proxy_set_header:
      {{#each headers}}
      {{key}}: {{value}}
      {{/each}}
    {{/if}}
    {{#if rateLimit}}
    rate_limit:
      requests: {{rateLimit.requests}}
      per: {{rateLimit.per}}
    {{/if}}
  {{/each}}
  {{/each}}

{{#if ssl}}
ssl:
  certificate: {{ssl.certificate}}
  certificate_key: {{ssl.certificateKey}}
  protocols:
    {{#each ssl.protocols}}
    - {{this}}
    {{/each}}
{{/if}}

{{else}}
# Generic API Gateway Configuration (Traefik/Envoy compatible)
api_gateway:
  name: {{projectName}}-gateway
  version: "{{version}}"
  
  entrypoints:
    http:
      port: 80
    https:
      port: 443
      {{#if tls}}
      tls:
        certResolver: {{tls.certResolver}}
      {{/if}}

  middlewares:
    {{#if authMiddleware}}
    auth:
      type: {{authMiddleware.type}}
      {{#if authMiddleware.jwt}}
      jwt:
        issuer: {{authMiddleware.jwt.issuer}}
        audience: {{authMiddleware.jwt.audience}}
        jwksUri: {{authMiddleware.jwt.jwksUri}}
      {{/if}}
    {{/if}}
    {{#if rateLimitMiddleware}}
    rate-limit:
      average: {{rateLimitMiddleware.average}}
      burst: {{rateLimitMiddleware.burst}}
      period: {{rateLimitMiddleware.period}}
    {{/if}}
    {{#if circuitBreaker}}
    circuit-breaker:
      expression: {{circuitBreaker.expression}}
      fallback: {{circuitBreaker.fallback}}
    {{/if}}
    {{#if retry}}
    retry:
      attempts: {{retry.attempts}}
      initialInterval: {{retry.initialInterval}}
    {{/if}}

  routers:
    {{#each services}}
    {{kebabCase name}}:
      rule: "{{routeRule}}"
      service: {{kebabCase name}}-service
      {{#if middlewares}}
      middlewares:
        {{#each middlewares}}
        - {{this}}
        {{/each}}
      {{/if}}
      {{#if priority}}
      priority: {{priority}}
      {{/if}}
    {{/each}}

  services:
    {{#each services}}
    {{kebabCase name}}-service:
      loadBalancer:
        servers:
          {{#each servers}}
          - url: {{url}}
          {{/each}}
        {{#if healthCheck}}
        healthCheck:
          path: {{healthCheck.path}}
          interval: {{healthCheck.interval}}
        {{/if}}
        {{#if sticky}}
        sticky:
          cookie:
            name: {{sticky.cookieName}}
        {{/if}}
    {{/each}}
{{/if}}
{{/if}}
