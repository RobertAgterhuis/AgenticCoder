# Kubernetes Service Template: {{serviceName}}
# {{description}}
# Generated by AgenticCoder

{{#if namespace}}
---
apiVersion: v1
kind: Namespace
metadata:
  name: {{namespace}}
  labels:
    name: {{namespace}}
    {{#each namespaceLabels}}
    {{key}}: "{{value}}"
    {{/each}}
{{/if}}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{kebabCase serviceName}}
  {{#if namespace}}
  namespace: {{namespace}}
  {{/if}}
  labels:
    app: {{kebabCase serviceName}}
    version: "{{version}}"
    {{#each labels}}
    {{key}}: "{{value}}"
    {{/each}}
  {{#if annotations}}
  annotations:
    {{#each annotations}}
    {{key}}: "{{value}}"
    {{/each}}
  {{/if}}
spec:
  replicas: {{replicas}}
  {{#if strategy}}
  strategy:
    type: {{strategy.type}}
    {{#if strategy.rollingUpdate}}
    rollingUpdate:
      maxSurge: {{strategy.rollingUpdate.maxSurge}}
      maxUnavailable: {{strategy.rollingUpdate.maxUnavailable}}
    {{/if}}
  {{/if}}
  selector:
    matchLabels:
      app: {{kebabCase serviceName}}
  template:
    metadata:
      labels:
        app: {{kebabCase serviceName}}
        version: "{{version}}"
        {{#each podLabels}}
        {{key}}: "{{value}}"
        {{/each}}
      {{#if podAnnotations}}
      annotations:
        {{#each podAnnotations}}
        {{key}}: "{{value}}"
        {{/each}}
      {{/if}}
    spec:
      {{#if serviceAccountName}}
      serviceAccountName: {{serviceAccountName}}
      {{/if}}
      {{#if imagePullSecrets}}
      imagePullSecrets:
        {{#each imagePullSecrets}}
        - name: {{this}}
        {{/each}}
      {{/if}}
      {{#if initContainers}}
      initContainers:
        {{#each initContainers}}
        - name: {{name}}
          image: {{image}}
          {{#if command}}
          command:
            {{#each command}}
            - {{this}}
            {{/each}}
          {{/if}}
          {{#if volumeMounts}}
          volumeMounts:
            {{#each volumeMounts}}
            - name: {{name}}
              mountPath: {{mountPath}}
            {{/each}}
          {{/if}}
        {{/each}}
      {{/if}}
      containers:
        - name: {{kebabCase serviceName}}
          image: {{image}}:{{imageTag}}
          imagePullPolicy: {{imagePullPolicy}}
          {{#if command}}
          command:
            {{#each command}}
            - {{this}}
            {{/each}}
          {{/if}}
          {{#if args}}
          args:
            {{#each args}}
            - {{this}}
            {{/each}}
          {{/if}}
          ports:
            {{#each ports}}
            - name: {{name}}
              containerPort: {{containerPort}}
              protocol: {{protocol}}
            {{/each}}
          {{#if env}}
          env:
            {{#each env}}
            - name: {{name}}
              {{#if valueFrom}}
              valueFrom:
                {{#if valueFrom.secretKeyRef}}
                secretKeyRef:
                  name: {{valueFrom.secretKeyRef.name}}
                  key: {{valueFrom.secretKeyRef.key}}
                {{/if}}
                {{#if valueFrom.configMapKeyRef}}
                configMapKeyRef:
                  name: {{valueFrom.configMapKeyRef.name}}
                  key: {{valueFrom.configMapKeyRef.key}}
                {{/if}}
                {{#if valueFrom.fieldRef}}
                fieldRef:
                  fieldPath: {{valueFrom.fieldRef.fieldPath}}
                {{/if}}
              {{else}}
              value: "{{value}}"
              {{/if}}
            {{/each}}
          {{/if}}
          {{#if envFrom}}
          envFrom:
            {{#each envFrom}}
            {{#if configMapRef}}
            - configMapRef:
                name: {{configMapRef}}
            {{/if}}
            {{#if secretRef}}
            - secretRef:
                name: {{secretRef}}
            {{/if}}
            {{/each}}
          {{/if}}
          resources:
            limits:
              cpu: {{resources.limits.cpu}}
              memory: {{resources.limits.memory}}
            requests:
              cpu: {{resources.requests.cpu}}
              memory: {{resources.requests.memory}}
          {{#if livenessProbe}}
          livenessProbe:
            {{#if livenessProbe.httpGet}}
            httpGet:
              path: {{livenessProbe.httpGet.path}}
              port: {{livenessProbe.httpGet.port}}
            {{/if}}
            {{#if livenessProbe.tcpSocket}}
            tcpSocket:
              port: {{livenessProbe.tcpSocket.port}}
            {{/if}}
            {{#if livenessProbe.exec}}
            exec:
              command:
                {{#each livenessProbe.exec.command}}
                - {{this}}
                {{/each}}
            {{/if}}
            initialDelaySeconds: {{livenessProbe.initialDelaySeconds}}
            periodSeconds: {{livenessProbe.periodSeconds}}
            timeoutSeconds: {{livenessProbe.timeoutSeconds}}
            failureThreshold: {{livenessProbe.failureThreshold}}
          {{/if}}
          {{#if readinessProbe}}
          readinessProbe:
            {{#if readinessProbe.httpGet}}
            httpGet:
              path: {{readinessProbe.httpGet.path}}
              port: {{readinessProbe.httpGet.port}}
            {{/if}}
            initialDelaySeconds: {{readinessProbe.initialDelaySeconds}}
            periodSeconds: {{readinessProbe.periodSeconds}}
            timeoutSeconds: {{readinessProbe.timeoutSeconds}}
          {{/if}}
          {{#if volumeMounts}}
          volumeMounts:
            {{#each volumeMounts}}
            - name: {{name}}
              mountPath: {{mountPath}}
              {{#if subPath}}
              subPath: {{subPath}}
              {{/if}}
              {{#if readOnly}}
              readOnly: {{readOnly}}
              {{/if}}
            {{/each}}
          {{/if}}
          {{#if securityContext}}
          securityContext:
            {{#if securityContext.runAsNonRoot}}
            runAsNonRoot: {{securityContext.runAsNonRoot}}
            {{/if}}
            {{#if securityContext.runAsUser}}
            runAsUser: {{securityContext.runAsUser}}
            {{/if}}
            {{#if securityContext.readOnlyRootFilesystem}}
            readOnlyRootFilesystem: {{securityContext.readOnlyRootFilesystem}}
            {{/if}}
          {{/if}}
      {{#if volumes}}
      volumes:
        {{#each volumes}}
        - name: {{name}}
          {{#if configMap}}
          configMap:
            name: {{configMap.name}}
          {{/if}}
          {{#if secret}}
          secret:
            secretName: {{secret.secretName}}
          {{/if}}
          {{#if persistentVolumeClaim}}
          persistentVolumeClaim:
            claimName: {{persistentVolumeClaim.claimName}}
          {{/if}}
          {{#if emptyDir}}
          emptyDir: {}
          {{/if}}
        {{/each}}
      {{/if}}
      {{#if nodeSelector}}
      nodeSelector:
        {{#each nodeSelector}}
        {{key}}: "{{value}}"
        {{/each}}
      {{/if}}
      {{#if tolerations}}
      tolerations:
        {{#each tolerations}}
        - key: "{{key}}"
          operator: "{{operator}}"
          {{#if value}}
          value: "{{value}}"
          {{/if}}
          effect: "{{effect}}"
        {{/each}}
      {{/if}}

---
apiVersion: v1
kind: Service
metadata:
  name: {{kebabCase serviceName}}
  {{#if namespace}}
  namespace: {{namespace}}
  {{/if}}
  labels:
    app: {{kebabCase serviceName}}
spec:
  type: {{serviceType}}
  {{#if clusterIP}}
  clusterIP: {{clusterIP}}
  {{/if}}
  ports:
    {{#each servicePorts}}
    - name: {{name}}
      port: {{port}}
      targetPort: {{targetPort}}
      protocol: {{protocol}}
      {{#if nodePort}}
      nodePort: {{nodePort}}
      {{/if}}
    {{/each}}
  selector:
    app: {{kebabCase serviceName}}

{{#if hpa}}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{kebabCase serviceName}}-hpa
  {{#if namespace}}
  namespace: {{namespace}}
  {{/if}}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{kebabCase serviceName}}
  minReplicas: {{hpa.minReplicas}}
  maxReplicas: {{hpa.maxReplicas}}
  metrics:
    {{#each hpa.metrics}}
    - type: {{type}}
      {{#if resource}}
      resource:
        name: {{resource.name}}
        target:
          type: {{resource.target.type}}
          {{#if resource.target.averageUtilization}}
          averageUtilization: {{resource.target.averageUtilization}}
          {{/if}}
      {{/if}}
    {{/each}}
{{/if}}

{{#if ingress}}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{kebabCase serviceName}}-ingress
  {{#if namespace}}
  namespace: {{namespace}}
  {{/if}}
  {{#if ingress.annotations}}
  annotations:
    {{#each ingress.annotations}}
    {{key}}: "{{value}}"
    {{/each}}
  {{/if}}
spec:
  {{#if ingress.ingressClassName}}
  ingressClassName: {{ingress.ingressClassName}}
  {{/if}}
  {{#if ingress.tls}}
  tls:
    {{#each ingress.tls}}
    - hosts:
        {{#each hosts}}
        - {{this}}
        {{/each}}
      secretName: {{secretName}}
    {{/each}}
  {{/if}}
  rules:
    {{#each ingress.rules}}
    - host: {{host}}
      http:
        paths:
          {{#each paths}}
          - path: {{path}}
            pathType: {{pathType}}
            backend:
              service:
                name: {{serviceName}}
                port:
                  number: {{servicePort}}
          {{/each}}
    {{/each}}
{{/if}}
