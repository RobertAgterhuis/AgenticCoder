// Bicep Template: Azure SQL Database
// {{description}}
// Generated by AgenticCoder

@description('The name of the SQL Server')
param serverName string

@description('The name of the SQL Database')
param databaseName string

@description('The location for resources')
param location string = resourceGroup().location

@description('The administrator login for SQL Server')
param administratorLogin string

@description('The administrator password for SQL Server')
@secure()
param administratorLoginPassword string

@description('The SKU name for the database')
@allowed([
  'Basic'
  'S0'
  'S1'
  'S2'
  'S3'
  'S4'
  'S6'
  'S7'
  'S9'
  'S12'
  'P1'
  'P2'
  'P4'
  'P6'
  'P11'
  'P15'
  'GP_Gen5_2'
  'GP_Gen5_4'
  'GP_Gen5_8'
  'GP_Gen5_16'
  'GP_Gen5_24'
  'GP_Gen5_32'
  'GP_Gen5_40'
  'GP_Gen5_80'
  'GP_S_Gen5_1'
  'GP_S_Gen5_2'
  'GP_S_Gen5_4'
  'BC_Gen5_2'
  'BC_Gen5_4'
  'BC_Gen5_8'
  'BC_Gen5_16'
  'BC_Gen5_24'
  'BC_Gen5_32'
  'BC_Gen5_40'
  'BC_Gen5_80'
])
param skuName string = '{{skuName}}'

@description('Maximum size of the database in bytes')
param maxSizeBytes int = {{maxSizeBytes}}

@description('Enable Azure AD authentication only')
param enableAadAuthOnly bool = {{enableAadAuthOnly}}

{{#if aadAdmin}}
@description('Azure AD admin object ID')
param aadAdminObjectId string

@description('Azure AD admin login name')
param aadAdminLogin string

@description('Azure AD admin tenant ID')
param aadAdminTenantId string = subscription().tenantId
{{/if}}

@description('Enable zone redundancy')
param zoneRedundant bool = {{zoneRedundant}}

@description('Backup storage redundancy')
@allowed([
  'Geo'
  'Local'
  'Zone'
  'GeoZone'
])
param backupStorageRedundancy string = '{{backupStorageRedundancy}}'

{{#if enableTransparentDataEncryption}}
@description('Enable Transparent Data Encryption')
param enableTransparentDataEncryption bool = true
{{/if}}

{{#if enableAdvancedThreatProtection}}
@description('Enable Advanced Threat Protection')
param enableAdvancedThreatProtection bool = true
{{/if}}

{{#if enableAuditing}}
@description('Enable auditing to Storage Account')
param enableAuditing bool = true

@description('Storage Account ID for audit logs')
param auditStorageAccountId string
{{/if}}

{{#if privateEndpoint}}
@description('Subnet ID for private endpoint')
param privateEndpointSubnetId string
{{/if}}

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// SQL Server
resource sqlServer 'Microsoft.Sql/servers@2023-05-01-preview' = {
  name: serverName
  location: location
  tags: tags
  properties: {
    administratorLogin: enableAadAuthOnly ? null : administratorLogin
    administratorLoginPassword: enableAadAuthOnly ? null : administratorLoginPassword
    version: '12.0'
    minimalTlsVersion: '1.2'
    publicNetworkAccess: {{#if privateEndpoint}}'Disabled'{{else}}'Enabled'{{/if}}
    {{#if aadAdmin}}
    administrators: {
      administratorType: 'ActiveDirectory'
      principalType: 'Group'
      login: aadAdminLogin
      sid: aadAdminObjectId
      tenantId: aadAdminTenantId
      azureADOnlyAuthentication: enableAadAuthOnly
    }
    {{/if}}
  }
}

// SQL Database
resource sqlDatabase 'Microsoft.Sql/servers/databases@2023-05-01-preview' = {
  parent: sqlServer
  name: databaseName
  location: location
  tags: tags
  sku: {
    name: skuName
    {{#if skuTier}}
    tier: '{{skuTier}}'
    {{/if}}
    {{#if skuCapacity}}
    capacity: {{skuCapacity}}
    {{/if}}
  }
  properties: {
    collation: '{{collation}}'
    maxSizeBytes: maxSizeBytes
    zoneRedundant: zoneRedundant
    requestedBackupStorageRedundancy: backupStorageRedundancy
    {{#if elasticPoolId}}
    elasticPoolId: '{{elasticPoolId}}'
    {{/if}}
    {{#if sampleName}}
    sampleName: '{{sampleName}}'
    {{/if}}
    {{#if autoPauseDelay}}
    autoPauseDelay: {{autoPauseDelay}}
    {{/if}}
    {{#if minCapacity}}
    minCapacity: {{minCapacity}}
    {{/if}}
    {{#if readScale}}
    readScale: '{{readScale}}'
    {{/if}}
    {{#if highAvailabilityReplicaCount}}
    highAvailabilityReplicaCount: {{highAvailabilityReplicaCount}}
    {{/if}}
    {{#if maintenanceConfigurationId}}
    maintenanceConfigurationId: '{{maintenanceConfigurationId}}'
    {{/if}}
  }
}

{{#if enableTransparentDataEncryption}}
// Transparent Data Encryption
resource tde 'Microsoft.Sql/servers/databases/transparentDataEncryption@2023-05-01-preview' = {
  parent: sqlDatabase
  name: 'current'
  properties: {
    state: 'Enabled'
  }
}
{{/if}}

{{#if enableAdvancedThreatProtection}}
// Advanced Threat Protection
resource atp 'Microsoft.Sql/servers/databases/securityAlertPolicies@2023-05-01-preview' = {
  parent: sqlDatabase
  name: 'default'
  properties: {
    state: 'Enabled'
    emailAccountAdmins: true
    {{#if securityAlertEmails}}
    emailAddresses: [{{#each securityAlertEmails}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
  }
}

// Vulnerability Assessment
resource va 'Microsoft.Sql/servers/databases/vulnerabilityAssessments@2023-05-01-preview' = {
  parent: sqlDatabase
  name: 'default'
  properties: {
    recurringScans: {
      isEnabled: true
      emailSubscriptionAdmins: true
    }
  }
}
{{/if}}

{{#if enableAuditing}}
// Auditing
resource serverAudit 'Microsoft.Sql/servers/auditingSettings@2023-05-01-preview' = {
  parent: sqlServer
  name: 'default'
  properties: {
    state: 'Enabled'
    storageEndpoint: reference(auditStorageAccountId, '2021-09-01').primaryEndpoints.blob
    storageAccountAccessKey: listKeys(auditStorageAccountId, '2021-09-01').keys[0].value
    retentionDays: {{auditRetentionDays}}
    auditActionsAndGroups: [
      'SUCCESSFUL_DATABASE_AUTHENTICATION_GROUP'
      'FAILED_DATABASE_AUTHENTICATION_GROUP'
      'BATCH_COMPLETED_GROUP'
    ]
    isStorageSecondaryKeyInUse: false
  }
}
{{/if}}

{{#if firewallRules}}
// Firewall Rules
{{#each firewallRules}}
resource firewallRule_{{@index}} 'Microsoft.Sql/servers/firewallRules@2023-05-01-preview' = {
  parent: sqlServer
  name: '{{name}}'
  properties: {
    startIpAddress: '{{startIpAddress}}'
    endIpAddress: '{{endIpAddress}}'
  }
}

{{/each}}
{{/if}}

{{#if allowAzureServices}}
// Allow Azure Services
resource allowAzureServices 'Microsoft.Sql/servers/firewallRules@2023-05-01-preview' = {
  parent: sqlServer
  name: 'AllowAllWindowsAzureIps'
  properties: {
    startIpAddress: '0.0.0.0'
    endIpAddress: '0.0.0.0'
  }
}
{{/if}}

{{#if privateEndpoint}}
// Private Endpoint
resource privateEndpoint 'Microsoft.Network/privateEndpoints@2023-04-01' = {
  name: '${serverName}-pe'
  location: location
  tags: tags
  properties: {
    subnet: {
      id: privateEndpointSubnetId
    }
    privateLinkServiceConnections: [
      {
        name: '${serverName}-plsc'
        properties: {
          privateLinkServiceId: sqlServer.id
          groupIds: [
            'sqlServer'
          ]
        }
      }
    ]
  }
}
{{/if}}

// Outputs
output serverId string = sqlServer.id
output serverName string = sqlServer.name
output serverFqdn string = sqlServer.properties.fullyQualifiedDomainName
output databaseId string = sqlDatabase.id
output databaseName string = sqlDatabase.name
output connectionString string = 'Server=tcp:${sqlServer.properties.fullyQualifiedDomainName},1433;Initial Catalog=${databaseName};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;'
