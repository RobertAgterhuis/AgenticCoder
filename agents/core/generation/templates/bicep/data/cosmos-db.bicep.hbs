// Bicep Template: Azure Cosmos DB
// {{description}}
// Generated by AgenticCoder

@description('The name of the Cosmos DB account')
param accountName string

@description('The location for the Cosmos DB account')
param location string = resourceGroup().location

@description('The API type for Cosmos DB')
@allowed([
  'Sql'
  'MongoDB'
  'Cassandra'
  'Gremlin'
  'Table'
])
param apiType string = '{{apiType}}'

@description('The default consistency level')
@allowed([
  'Eventual'
  'ConsistentPrefix'
  'Session'
  'BoundedStaleness'
  'Strong'
])
param defaultConsistencyLevel string = '{{consistencyLevel}}'

@description('Enable automatic failover')
param enableAutomaticFailover bool = {{enableAutomaticFailover}}

@description('Enable multi-region writes')
param enableMultipleWriteLocations bool = {{enableMultipleWriteLocations}}

@description('Enable free tier (only one per subscription)')
param enableFreeTier bool = {{enableFreeTier}}

@description('Enable serverless capacity mode')
param enableServerless bool = {{enableServerless}}

{{#if enableAnalyticalStorage}}
@description('Enable analytical storage')
param enableAnalyticalStorage bool = true
{{/if}}

{{#if privateEndpoint}}
@description('Disable public network access')
param disablePublicNetworkAccess bool = true

@description('The subnet ID for private endpoint')
param privateEndpointSubnetId string
{{/if}}

@description('Secondary regions for geo-replication')
param secondaryRegions array = [
  {{#each secondaryRegions}}
  {
    locationName: '{{location}}'
    failoverPriority: {{priority}}
    isZoneRedundant: {{zoneRedundant}}
  }
  {{/each}}
]

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// Cosmos DB Account
resource cosmosAccount 'Microsoft.DocumentDB/databaseAccounts@2023-04-15' = {
  name: accountName
  location: location
  tags: tags
  kind: apiType == 'MongoDB' ? 'MongoDB' : 'GlobalDocumentDB'
  properties: {
    databaseAccountOfferType: 'Standard'
    enableFreeTier: enableFreeTier
    consistencyPolicy: {
      defaultConsistencyLevel: defaultConsistencyLevel
      {{#if boundedStaleness}}
      maxStalenessPrefix: {{maxStalenessPrefix}}
      maxIntervalInSeconds: {{maxIntervalInSeconds}}
      {{/if}}
    }
    locations: concat([
      {
        locationName: location
        failoverPriority: 0
        isZoneRedundant: {{primaryZoneRedundant}}
      }
    ], secondaryRegions)
    enableAutomaticFailover: enableAutomaticFailover
    enableMultipleWriteLocations: enableMultipleWriteLocations
    {{#if enableAnalyticalStorage}}
    enableAnalyticalStorage: enableAnalyticalStorage
    analyticalStorageConfiguration: {
      schemaType: 'WellDefined'
    }
    {{/if}}
    capabilities: enableServerless ? [
      {
        name: 'EnableServerless'
      }
    ] : []
    {{#if privateEndpoint}}
    publicNetworkAccess: disablePublicNetworkAccess ? 'Disabled' : 'Enabled'
    {{/if}}
    backupPolicy: {
      type: '{{backupPolicyType}}'
      {{#if continuousBackup}}
      continuousModeProperties: {
        tier: '{{continuousBackupTier}}'
      }
      {{else}}
      periodicModeProperties: {
        backupIntervalInMinutes: {{backupIntervalInMinutes}}
        backupRetentionIntervalInHours: {{backupRetentionIntervalInHours}}
        backupStorageRedundancy: '{{backupStorageRedundancy}}'
      }
      {{/if}}
    }
    cors: [
      {{#each corsRules}}
      {
        allowedOrigins: '{{allowedOrigins}}'
        allowedMethods: '{{allowedMethods}}'
        allowedHeaders: '{{allowedHeaders}}'
        exposedHeaders: '{{exposedHeaders}}'
        maxAgeInSeconds: {{maxAgeInSeconds}}
      }
      {{/each}}
    ]
  }
}

// SQL Database (if using SQL API)
{{#if databases}}
{{#each databases}}
resource database_{{camelCase name}} 'Microsoft.DocumentDB/databaseAccounts/sqlDatabases@2023-04-15' = {
  parent: cosmosAccount
  name: '{{name}}'
  properties: {
    resource: {
      id: '{{name}}'
    }
    {{#unless ../enableServerless}}
    options: {
      {{#if autoscale}}
      autoscaleSettings: {
        maxThroughput: {{maxThroughput}}
      }
      {{else}}
      throughput: {{throughput}}
      {{/if}}
    }
    {{/unless}}
  }
}

{{#each containers}}
resource container_{{camelCase ../name}}_{{camelCase name}} 'Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2023-04-15' = {
  parent: database_{{camelCase ../name}}
  name: '{{name}}'
  properties: {
    resource: {
      id: '{{name}}'
      partitionKey: {
        paths: [{{#each partitionKeyPaths}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
        kind: '{{partitionKeyKind}}'
      }
      {{#if uniqueKeys}}
      uniqueKeyPolicy: {
        uniqueKeys: [
          {{#each uniqueKeys}}
          {
            paths: [{{#each paths}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          }
          {{/each}}
        ]
      }
      {{/if}}
      indexingPolicy: {
        indexingMode: '{{indexingMode}}'
        automatic: true
        includedPaths: [
          {{#each includedPaths}}
          {
            path: '{{path}}'
          }
          {{/each}}
        ]
        excludedPaths: [
          {
            path: '/"_etag"/?'
          }
          {{#each excludedPaths}}
          {
            path: '{{path}}'
          }
          {{/each}}
        ]
        {{#if compositeIndexes}}
        compositeIndexes: [
          {{#each compositeIndexes}}
          [
            {{#each this}}
            {
              path: '{{path}}'
              order: '{{order}}'
            }
            {{/each}}
          ]
          {{/each}}
        ]
        {{/if}}
      }
      {{#if defaultTtl}}
      defaultTtl: {{defaultTtl}}
      {{/if}}
    }
    {{#unless ../../enableServerless}}
    {{#if throughput}}
    options: {
      {{#if autoscale}}
      autoscaleSettings: {
        maxThroughput: {{maxThroughput}}
      }
      {{else}}
      throughput: {{throughput}}
      {{/if}}
    }
    {{/if}}
    {{/unless}}
  }
}
{{/each}}

{{/each}}
{{/if}}

{{#if privateEndpoint}}
// Private Endpoint
resource privateEndpoint 'Microsoft.Network/privateEndpoints@2023-04-01' = {
  name: '${accountName}-pe'
  location: location
  tags: tags
  properties: {
    subnet: {
      id: privateEndpointSubnetId
    }
    privateLinkServiceConnections: [
      {
        name: '${accountName}-plsc'
        properties: {
          privateLinkServiceId: cosmosAccount.id
          groupIds: [
            'Sql'
          ]
        }
      }
    ]
  }
}
{{/if}}

// Outputs
output accountId string = cosmosAccount.id
output accountName string = cosmosAccount.name
output documentEndpoint string = cosmosAccount.properties.documentEndpoint
output primaryMasterKey string = cosmosAccount.listKeys().primaryMasterKey
output connectionString string = cosmosAccount.listConnectionStrings().connectionStrings[0].connectionString
