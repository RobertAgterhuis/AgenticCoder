// Bicep Template: Azure Application Gateway
// {{description}}
// Generated by AgenticCoder

@description('The name of the Application Gateway')
param appGatewayName string

@description('The location for the Application Gateway')
param location string = resourceGroup().location

@description('The SKU tier of the Application Gateway')
@allowed([
  'Standard_v2'
  'WAF_v2'
])
param skuTier string = '{{skuTier}}'

@description('The SKU name of the Application Gateway')
@allowed([
  'Standard_v2'
  'WAF_v2'
])
param skuName string = '{{skuName}}'

@description('Minimum capacity for autoscaling')
@minValue(0)
@maxValue(125)
param minCapacity int = {{minCapacity}}

@description('Maximum capacity for autoscaling')
@minValue(1)
@maxValue(125)
param maxCapacity int = {{maxCapacity}}

@description('The subnet ID for the Application Gateway')
param subnetId string

@description('Enable HTTP/2')
param enableHttp2 bool = {{enableHttp2}}

{{#if enableWaf}}
@description('WAF policy mode')
@allowed([
  'Detection'
  'Prevention'
])
param wafMode string = '{{wafMode}}'

@description('WAF rule set type')
param wafRuleSetType string = 'OWASP'

@description('WAF rule set version')
param wafRuleSetVersion string = '3.2'
{{/if}}

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// Public IP for Application Gateway
resource publicIp 'Microsoft.Network/publicIPAddresses@2023-04-01' = {
  name: '${appGatewayName}-pip'
  location: location
  tags: tags
  sku: {
    name: 'Standard'
    tier: 'Regional'
  }
  properties: {
    publicIPAllocationMethod: 'Static'
    dnsSettings: {
      domainNameLabel: toLower(appGatewayName)
    }
  }
}

{{#if enableWaf}}
// WAF Policy
resource wafPolicy 'Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies@2023-04-01' = {
  name: '${appGatewayName}-waf-policy'
  location: location
  tags: tags
  properties: {
    policySettings: {
      requestBodyCheck: true
      maxRequestBodySizeInKb: 128
      fileUploadLimitInMb: 100
      state: 'Enabled'
      mode: wafMode
    }
    managedRules: {
      managedRuleSets: [
        {
          ruleSetType: wafRuleSetType
          ruleSetVersion: wafRuleSetVersion
        }
      ]
      {{#if wafExclusions}}
      exclusions: [
        {{#each wafExclusions}}
        {
          matchVariable: '{{matchVariable}}'
          selectorMatchOperator: '{{selectorMatchOperator}}'
          selector: '{{selector}}'
        }
        {{/each}}
      ]
      {{/if}}
    }
    {{#if customRules}}
    customRules: [
      {{#each customRules}}
      {
        name: '{{name}}'
        priority: {{priority}}
        ruleType: '{{ruleType}}'
        action: '{{action}}'
        matchConditions: [
          {{#each matchConditions}}
          {
            matchVariables: [
              {
                variableName: '{{variableName}}'
                {{#if selector}}selector: '{{selector}}'{{/if}}
              }
            ]
            operator: '{{operator}}'
            matchValues: [{{#each matchValues}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
            {{#if negationCondition}}negationCondition: {{negationCondition}}{{/if}}
          }
          {{/each}}
        ]
      }
      {{/each}}
    ]
    {{/if}}
  }
}
{{/if}}

// Application Gateway
resource appGateway 'Microsoft.Network/applicationGateways@2023-04-01' = {
  name: appGatewayName
  location: location
  tags: tags
  properties: {
    sku: {
      name: skuName
      tier: skuTier
    }
    autoscaleConfiguration: {
      minCapacity: minCapacity
      maxCapacity: maxCapacity
    }
    enableHttp2: enableHttp2
    {{#if enableWaf}}
    firewallPolicy: {
      id: wafPolicy.id
    }
    {{/if}}
    gatewayIPConfigurations: [
      {
        name: 'appGatewayIpConfig'
        properties: {
          subnet: {
            id: subnetId
          }
        }
      }
    ]
    frontendIPConfigurations: [
      {
        name: 'appGatewayFrontendIP'
        properties: {
          publicIPAddress: {
            id: publicIp.id
          }
        }
      }
    ]
    frontendPorts: [
      {
        name: 'port_80'
        properties: {
          port: 80
        }
      }
      {
        name: 'port_443'
        properties: {
          port: 443
        }
      }
    ]
    {{#if sslCertificates}}
    sslCertificates: [
      {{#each sslCertificates}}
      {
        name: '{{name}}'
        properties: {
          {{#if keyVaultSecretId}}
          keyVaultSecretId: '{{keyVaultSecretId}}'
          {{else}}
          data: '{{data}}'
          password: '{{password}}'
          {{/if}}
        }
      }
      {{/each}}
    ]
    {{/if}}
    backendAddressPools: [
      {{#each backendPools}}
      {
        name: '{{name}}'
        properties: {
          backendAddresses: [
            {{#each addresses}}
            {
              {{#if fqdn}}fqdn: '{{fqdn}}'{{/if}}
              {{#if ipAddress}}ipAddress: '{{ipAddress}}'{{/if}}
            }
            {{/each}}
          ]
        }
      }
      {{/each}}
    ]
    backendHttpSettingsCollection: [
      {{#each httpSettings}}
      {
        name: '{{name}}'
        properties: {
          port: {{port}}
          protocol: '{{protocol}}'
          cookieBasedAffinity: '{{cookieBasedAffinity}}'
          requestTimeout: {{requestTimeout}}
          {{#if pickHostNameFromBackendAddress}}
          pickHostNameFromBackendAddress: {{pickHostNameFromBackendAddress}}
          {{/if}}
          {{#if probe}}
          probe: {
            id: resourceId('Microsoft.Network/applicationGateways/probes', appGatewayName, '{{probe}}')
          }
          {{/if}}
        }
      }
      {{/each}}
    ]
    httpListeners: [
      {{#each listeners}}
      {
        name: '{{name}}'
        properties: {
          frontendIPConfiguration: {
            id: resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', appGatewayName, 'appGatewayFrontendIP')
          }
          frontendPort: {
            id: resourceId('Microsoft.Network/applicationGateways/frontendPorts', appGatewayName, '{{frontendPort}}')
          }
          protocol: '{{protocol}}'
          {{#if hostName}}
          hostName: '{{hostName}}'
          {{/if}}
          {{#if sslCertificate}}
          sslCertificate: {
            id: resourceId('Microsoft.Network/applicationGateways/sslCertificates', appGatewayName, '{{sslCertificate}}')
          }
          {{/if}}
        }
      }
      {{/each}}
    ]
    requestRoutingRules: [
      {{#each routingRules}}
      {
        name: '{{name}}'
        properties: {
          ruleType: '{{ruleType}}'
          priority: {{priority}}
          httpListener: {
            id: resourceId('Microsoft.Network/applicationGateways/httpListeners', appGatewayName, '{{httpListener}}')
          }
          {{#if backendAddressPool}}
          backendAddressPool: {
            id: resourceId('Microsoft.Network/applicationGateways/backendAddressPools', appGatewayName, '{{backendAddressPool}}')
          }
          {{/if}}
          {{#if backendHttpSettings}}
          backendHttpSettings: {
            id: resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', appGatewayName, '{{backendHttpSettings}}')
          }
          {{/if}}
          {{#if urlPathMap}}
          urlPathMap: {
            id: resourceId('Microsoft.Network/applicationGateways/urlPathMaps', appGatewayName, '{{urlPathMap}}')
          }
          {{/if}}
          {{#if redirectConfiguration}}
          redirectConfiguration: {
            id: resourceId('Microsoft.Network/applicationGateways/redirectConfigurations', appGatewayName, '{{redirectConfiguration}}')
          }
          {{/if}}
        }
      }
      {{/each}}
    ]
    {{#if probes}}
    probes: [
      {{#each probes}}
      {
        name: '{{name}}'
        properties: {
          protocol: '{{protocol}}'
          path: '{{path}}'
          interval: {{interval}}
          timeout: {{timeout}}
          unhealthyThreshold: {{unhealthyThreshold}}
          {{#if pickHostNameFromBackendHttpSettings}}
          pickHostNameFromBackendHttpSettings: {{pickHostNameFromBackendHttpSettings}}
          {{else}}
          host: '{{host}}'
          {{/if}}
          match: {
            statusCodes: [{{#each statusCodes}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          }
        }
      }
      {{/each}}
    ]
    {{/if}}
  }
}

// Outputs
output appGatewayId string = appGateway.id
output appGatewayName string = appGateway.name
output publicIpAddress string = publicIp.properties.ipAddress
output publicIpFqdn string = publicIp.properties.dnsSettings.fqdn
{{#if enableWaf}}
output wafPolicyId string = wafPolicy.id
{{/if}}
