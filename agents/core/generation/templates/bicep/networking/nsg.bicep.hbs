// Bicep Template: Azure Network Security Group
// {{description}}
// Generated by AgenticCoder

@description('The name of the Network Security Group')
param nsgName string

@description('The location for the NSG')
param location string = resourceGroup().location

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

{{#if enableFlowLogs}}
@description('Enable NSG Flow Logs')
param enableFlowLogs bool = true

@description('Storage Account ID for flow logs')
param flowLogStorageAccountId string

@description('Flow log retention in days')
param flowLogRetentionDays int = {{flowLogRetentionDays}}

@description('Log Analytics Workspace ID for traffic analytics')
param logAnalyticsWorkspaceId string = ''
{{/if}}

// Security Rules
var securityRules = [
  {{#each securityRules}}
  {
    name: '{{name}}'
    priority: {{priority}}
    direction: '{{direction}}'
    access: '{{access}}'
    protocol: '{{protocol}}'
    sourcePortRange: '{{sourcePortRange}}'
    destinationPortRange: '{{destinationPortRange}}'
    sourceAddressPrefix: '{{sourceAddressPrefix}}'
    destinationAddressPrefix: '{{destinationAddressPrefix}}'
    {{#if description}}
    description: '{{description}}'
    {{/if}}
    {{#if sourcePortRanges}}
    sourcePortRanges: [{{#each sourcePortRanges}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
    {{#if destinationPortRanges}}
    destinationPortRanges: [{{#each destinationPortRanges}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
    {{#if sourceAddressPrefixes}}
    sourceAddressPrefixes: [{{#each sourceAddressPrefixes}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
    {{#if destinationAddressPrefixes}}
    destinationAddressPrefixes: [{{#each destinationAddressPrefixes}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
    {{#if sourceApplicationSecurityGroups}}
    sourceApplicationSecurityGroupIds: [{{#each sourceApplicationSecurityGroups}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
    {{#if destinationApplicationSecurityGroups}}
    destinationApplicationSecurityGroupIds: [{{#each destinationApplicationSecurityGroups}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
  }
  {{/each}}
]

// Common security rule templates
var commonRules = {
  allowHttps: {
    name: 'Allow-HTTPS-Inbound'
    priority: 100
    direction: 'Inbound'
    access: 'Allow'
    protocol: 'Tcp'
    sourcePortRange: '*'
    destinationPortRange: '443'
    sourceAddressPrefix: '*'
    destinationAddressPrefix: '*'
  }
  allowHttp: {
    name: 'Allow-HTTP-Inbound'
    priority: 110
    direction: 'Inbound'
    access: 'Allow'
    protocol: 'Tcp'
    sourcePortRange: '*'
    destinationPortRange: '80'
    sourceAddressPrefix: '*'
    destinationAddressPrefix: '*'
  }
  allowSsh: {
    name: 'Allow-SSH-Inbound'
    priority: 120
    direction: 'Inbound'
    access: 'Allow'
    protocol: 'Tcp'
    sourcePortRange: '*'
    destinationPortRange: '22'
    sourceAddressPrefix: '*'
    destinationAddressPrefix: '*'
  }
  allowRdp: {
    name: 'Allow-RDP-Inbound'
    priority: 130
    direction: 'Inbound'
    access: 'Allow'
    protocol: 'Tcp'
    sourcePortRange: '*'
    destinationPortRange: '3389'
    sourceAddressPrefix: '*'
    destinationAddressPrefix: '*'
  }
  denyAllInbound: {
    name: 'Deny-All-Inbound'
    priority: 4096
    direction: 'Inbound'
    access: 'Deny'
    protocol: '*'
    sourcePortRange: '*'
    destinationPortRange: '*'
    sourceAddressPrefix: '*'
    destinationAddressPrefix: '*'
  }
}

// Network Security Group
resource nsg 'Microsoft.Network/networkSecurityGroups@2023-04-01' = {
  name: nsgName
  location: location
  tags: tags
  properties: {
    securityRules: [for rule in securityRules: {
      name: rule.name
      properties: {
        priority: rule.priority
        direction: rule.direction
        access: rule.access
        protocol: rule.protocol
        sourcePortRange: contains(rule, 'sourcePortRanges') ? null : rule.sourcePortRange
        destinationPortRange: contains(rule, 'destinationPortRanges') ? null : rule.destinationPortRange
        sourceAddressPrefix: contains(rule, 'sourceAddressPrefixes') ? null : rule.sourceAddressPrefix
        destinationAddressPrefix: contains(rule, 'destinationAddressPrefixes') ? null : rule.destinationAddressPrefix
        sourcePortRanges: contains(rule, 'sourcePortRanges') ? rule.sourcePortRanges : null
        destinationPortRanges: contains(rule, 'destinationPortRanges') ? rule.destinationPortRanges : null
        sourceAddressPrefixes: contains(rule, 'sourceAddressPrefixes') ? rule.sourceAddressPrefixes : null
        destinationAddressPrefixes: contains(rule, 'destinationAddressPrefixes') ? rule.destinationAddressPrefixes : null
        sourceApplicationSecurityGroups: contains(rule, 'sourceApplicationSecurityGroupIds') ? [for id in rule.sourceApplicationSecurityGroupIds: {
          id: id
        }] : null
        destinationApplicationSecurityGroups: contains(rule, 'destinationApplicationSecurityGroupIds') ? [for id in rule.destinationApplicationSecurityGroupIds: {
          id: id
        }] : null
        description: contains(rule, 'description') ? rule.description : null
      }
    }]
  }
}

{{#if enableFlowLogs}}
// NSG Flow Logs
resource flowLog 'Microsoft.Network/networkWatchers/flowLogs@2023-04-01' = if (enableFlowLogs) {
  name: 'NetworkWatcher_${location}/${nsgName}-flowlog'
  location: location
  tags: tags
  properties: {
    targetResourceId: nsg.id
    storageId: flowLogStorageAccountId
    enabled: true
    retentionPolicy: {
      enabled: true
      days: flowLogRetentionDays
    }
    format: {
      type: 'JSON'
      version: 2
    }
    flowAnalyticsConfiguration: !empty(logAnalyticsWorkspaceId) ? {
      networkWatcherFlowAnalyticsConfiguration: {
        enabled: true
        workspaceResourceId: logAnalyticsWorkspaceId
        trafficAnalyticsInterval: 10
      }
    } : null
  }
}
{{/if}}

{{#if diagnosticSettings}}
// Diagnostic Settings
resource diagnosticSetting 'Microsoft.Insights/diagnosticSettings@2021-05-01-preview' = {
  name: '${nsgName}-diagnostics'
  scope: nsg
  properties: {
    {{#if logAnalyticsWorkspaceId}}
    workspaceId: '{{logAnalyticsWorkspaceId}}'
    {{/if}}
    {{#if storageAccountId}}
    storageAccountId: '{{storageAccountId}}'
    {{/if}}
    logs: [
      {
        categoryGroup: 'allLogs'
        enabled: true
        retentionPolicy: {
          enabled: true
          days: {{diagnosticRetentionDays}}
        }
      }
    ]
  }
}
{{/if}}

// Outputs
output nsgId string = nsg.id
output nsgName string = nsg.name
output securityRuleCount int = length(nsg.properties.securityRules)
