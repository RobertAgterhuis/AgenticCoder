// Bicep Template: Azure Virtual Network
// {{description}}
// Generated by AgenticCoder

@description('The name of the Virtual Network')
param vnetName string

@description('The location for the Virtual Network')
param location string = resourceGroup().location

@description('The address prefix for the VNet')
param addressPrefix string = '{{addressPrefix}}'

@description('Enable DDoS Protection')
param enableDdosProtection bool = {{enableDdosProtection}}

{{#if ddosProtectionPlanId}}
@description('The resource ID of the DDoS Protection Plan')
param ddosProtectionPlanId string = '{{ddosProtectionPlanId}}'
{{/if}}

@description('Enable VM Protection')
param enableVmProtection bool = {{enableVmProtection}}

@description('DNS Servers (empty for Azure-provided)')
param dnsServers array = [{{#each dnsServers}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// Subnet configurations
var subnets = [
  {{#each subnets}}
  {
    name: '{{name}}'
    addressPrefix: '{{addressPrefix}}'
    {{#if serviceEndpoints}}
    serviceEndpoints: [
      {{#each serviceEndpoints}}
      {
        service: '{{this}}'
        locations: ['*']
      }
      {{/each}}
    ]
    {{/if}}
    {{#if privateEndpointNetworkPolicies}}
    privateEndpointNetworkPolicies: '{{privateEndpointNetworkPolicies}}'
    {{/if}}
    {{#if privateLinkServiceNetworkPolicies}}
    privateLinkServiceNetworkPolicies: '{{privateLinkServiceNetworkPolicies}}'
    {{/if}}
    {{#if nsgId}}
    networkSecurityGroupId: '{{nsgId}}'
    {{/if}}
    {{#if routeTableId}}
    routeTableId: '{{routeTableId}}'
    {{/if}}
    {{#if delegation}}
    delegation: {
      name: '{{delegation.name}}'
      serviceName: '{{delegation.serviceName}}'
    }
    {{/if}}
    {{#if natGatewayId}}
    natGatewayId: '{{natGatewayId}}'
    {{/if}}
  }
  {{/each}}
]

// Virtual Network
resource vnet 'Microsoft.Network/virtualNetworks@2023-04-01' = {
  name: vnetName
  location: location
  tags: tags
  properties: {
    addressSpace: {
      addressPrefixes: [
        addressPrefix
      ]
    }
    {{#if enableDdosProtection}}
    enableDdosProtection: enableDdosProtection
    {{#if ddosProtectionPlanId}}
    ddosProtectionPlan: {
      id: ddosProtectionPlanId
    }
    {{/if}}
    {{/if}}
    enableVmProtection: enableVmProtection
    dhcpOptions: !empty(dnsServers) ? {
      dnsServers: dnsServers
    } : null
    subnets: [for subnet in subnets: {
      name: subnet.name
      properties: {
        addressPrefix: subnet.addressPrefix
        serviceEndpoints: contains(subnet, 'serviceEndpoints') ? subnet.serviceEndpoints : []
        privateEndpointNetworkPolicies: contains(subnet, 'privateEndpointNetworkPolicies') ? subnet.privateEndpointNetworkPolicies : 'Disabled'
        privateLinkServiceNetworkPolicies: contains(subnet, 'privateLinkServiceNetworkPolicies') ? subnet.privateLinkServiceNetworkPolicies : 'Enabled'
        networkSecurityGroup: contains(subnet, 'networkSecurityGroupId') ? {
          id: subnet.networkSecurityGroupId
        } : null
        routeTable: contains(subnet, 'routeTableId') ? {
          id: subnet.routeTableId
        } : null
        delegations: contains(subnet, 'delegation') ? [
          {
            name: subnet.delegation.name
            properties: {
              serviceName: subnet.delegation.serviceName
            }
          }
        ] : []
        natGateway: contains(subnet, 'natGatewayId') ? {
          id: subnet.natGatewayId
        } : null
      }
    }]
  }
}

{{#if peerings}}
// VNet Peerings
{{#each peerings}}
resource peering_{{camelCase name}} 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings@2023-04-01' = {
  parent: vnet
  name: '{{name}}'
  properties: {
    remoteVirtualNetwork: {
      id: '{{remoteVnetId}}'
    }
    allowVirtualNetworkAccess: {{allowVirtualNetworkAccess}}
    allowForwardedTraffic: {{allowForwardedTraffic}}
    allowGatewayTransit: {{allowGatewayTransit}}
    useRemoteGateways: {{useRemoteGateways}}
  }
}
{{/each}}
{{/if}}

// Outputs
output vnetId string = vnet.id
output vnetName string = vnet.name
output vnetAddressSpace array = vnet.properties.addressSpace.addressPrefixes
{{#each subnets}}
output subnet{{pascalCase name}}Id string = vnet.properties.subnets[{{@index}}].id
{{/each}}
