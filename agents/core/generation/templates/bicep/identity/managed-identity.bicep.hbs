// Bicep Template: User-Assigned Managed Identity
// {{description}}
// Generated by AgenticCoder

@description('The name of the managed identity')
param identityName string

@description('The location for the managed identity')
param location string = resourceGroup().location

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

{{#if roleAssignments}}
@description('Role assignments to grant to this identity')
param roleAssignments array = [
  {{#each roleAssignments}}
  {
    roleDefinitionId: '{{roleDefinitionId}}'
    scope: '{{scope}}'
    description: '{{description}}'
  }
  {{/each}}
]
{{/if}}

{{#if federatedCredentials}}
@description('Federated identity credentials for workload identity')
param federatedCredentials array = [
  {{#each federatedCredentials}}
  {
    name: '{{name}}'
    issuer: '{{issuer}}'
    subject: '{{subject}}'
    audiences: [{{#each audiences}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
  }
  {{/each}}
]
{{/if}}

// User-Assigned Managed Identity
resource managedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: identityName
  location: location
  tags: tags
}

{{#if federatedCredentials}}
// Federated Identity Credentials (for Kubernetes/GitHub Actions workload identity)
resource federatedCredential 'Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials@2023-01-31' = [for cred in federatedCredentials: {
  parent: managedIdentity
  name: cred.name
  properties: {
    issuer: cred.issuer
    subject: cred.subject
    audiences: cred.audiences
  }
}]
{{/if}}

{{#if roleAssignments}}
// Role Assignments
var builtInRoles = {
  Contributor: 'b24988ac-6180-42a0-ab88-20f7382dd24c'
  Reader: 'acdd72a7-3385-48ef-bd42-f606fba81ae7'
  Owner: '8e3af657-a8ff-443c-a75c-2fe8c4bcb635'
  StorageBlobDataContributor: 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'
  StorageBlobDataReader: '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1'
  KeyVaultSecretsUser: '4633458b-17de-408a-b874-0445c86b69e6'
  KeyVaultSecretsOfficer: 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7'
  AcrPull: '7f951dda-4ed3-4680-a7ca-43fe172d538d'
  AcrPush: '8311e382-0749-4cb8-b61a-304f252e45ec'
  CosmosDBAccountReader: 'fbdf93bf-df7d-467e-a4d2-9458aa1360c8'
  ServiceBusDataSender: '69a216fc-b8fb-44d8-bc22-1f3c2cd27a39'
  ServiceBusDataReceiver: '4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0'
}

resource roleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = [for assignment in roleAssignments: {
  name: guid(managedIdentity.id, assignment.roleDefinitionId, assignment.scope)
  scope: resourceGroup()
  properties: {
    roleDefinitionId: subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 
      contains(builtInRoles, assignment.roleDefinitionId) ? builtInRoles[assignment.roleDefinitionId] : assignment.roleDefinitionId)
    principalId: managedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    description: assignment.description
  }
}]
{{/if}}

// Outputs
output identityId string = managedIdentity.id
output identityName string = managedIdentity.name
output principalId string = managedIdentity.properties.principalId
output clientId string = managedIdentity.properties.clientId
output tenantId string = managedIdentity.properties.tenantId
