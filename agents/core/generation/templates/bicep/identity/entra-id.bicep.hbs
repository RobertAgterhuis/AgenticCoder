// Bicep Template: Microsoft Entra ID (Azure AD) Configuration
// {{description}}
// Generated by AgenticCoder

// Note: Entra ID resources are managed via Microsoft Graph API
// This template creates supporting Azure resources and role assignments

@description('The name of the application')
param applicationName string

@description('The location for resources')
param location string = resourceGroup().location

@description('Enable managed identity for the application')
param enableManagedIdentity bool = {{enableManagedIdentity}}

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

{{#if appRegistration}}
// App Registration Configuration (for reference - created via Graph API)
// This section documents the expected app registration settings
/*
App Registration:
  - Display Name: {{appRegistration.displayName}}
  - Sign-in Audience: {{appRegistration.signInAudience}}
  - Redirect URIs:
    {{#each appRegistration.redirectUris}}
    - {{this}}
    {{/each}}
  {{#if appRegistration.apiPermissions}}
  - API Permissions:
    {{#each appRegistration.apiPermissions}}
    - {{api}}: {{#each permissions}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
    {{/each}}
  {{/if}}
  {{#if appRegistration.appRoles}}
  - App Roles:
    {{#each appRegistration.appRoles}}
    - {{displayName}} ({{value}})
    {{/each}}
  {{/if}}
*/
{{/if}}

// User-Assigned Managed Identity
resource managedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = if (enableManagedIdentity) {
  name: '${applicationName}-identity'
  location: location
  tags: tags
}

{{#if federatedCredentials}}
// Federated Identity Credentials (for GitHub Actions, Kubernetes, etc.)
{{#each federatedCredentials}}
resource federatedCredential_{{@index}} 'Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials@2023-01-31' = {
  parent: managedIdentity
  name: '{{name}}'
  properties: {
    issuer: '{{issuer}}'
    subject: '{{subject}}'
    audiences: [
      {{#each audiences}}
      '{{this}}'{{#unless @last}},{{/unless}}
      {{/each}}
    ]
  }
}

{{/each}}
{{/if}}

{{#if roleAssignments}}
// Role Assignments
var builtInRoles = {
  Owner: '8e3af657-a8ff-443c-a75c-2fe8c4bcb635'
  Contributor: 'b24988ac-6180-42a0-ab88-20f7382dd24c'
  Reader: 'acdd72a7-3385-48ef-bd42-f606fba81ae7'
  UserAccessAdministrator: '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9'
  StorageBlobDataContributor: 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'
  StorageBlobDataReader: '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1'
  KeyVaultSecretsUser: '4633458b-17de-408a-b874-0445c86b69e6'
  KeyVaultSecretsOfficer: 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7'
  KeyVaultCryptoUser: '12338af0-0e69-4776-bea7-57ae8d297424'
  AcrPull: '7f951dda-4ed3-4680-a7ca-43fe172d538d'
  AcrPush: '8311e382-0749-4cb8-b61a-304f252e45ec'
  CosmosDBAccountReader: 'fbdf93bf-df7d-467e-a4d2-9458aa1360c8'
  CosmosDBOperator: '230815da-be43-4aae-9cb4-875f7bd000aa'
  ServiceBusDataSender: '69a216fc-b8fb-44d8-bc22-1f3c2cd27a39'
  ServiceBusDataReceiver: '4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0'
  EventHubsDataSender: '2b629674-e913-4c01-ae53-ef4638d8f975'
  EventHubsDataReceiver: 'a638d3c7-ab3a-418d-83e6-5f17a39d4fde'
  AppConfigurationDataReader: '516239f1-63e1-4d78-a4de-a74fb236a071'
}

{{#each roleAssignments}}
resource roleAssignment_{{@index}} 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid({{#if scope}}{{scope}}{{else}}resourceGroup().id{{/if}}, managedIdentity.id, '{{role}}')
  {{#if scope}}
  scope: {{scope}}
  {{/if}}
  properties: {
    roleDefinitionId: subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 
      contains(builtInRoles, '{{role}}') ? builtInRoles['{{role}}'] : '{{role}}')
    principalId: managedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    {{#if description}}
    description: '{{description}}'
    {{/if}}
  }
}

{{/each}}
{{/if}}

{{#if keyVaultAccess}}
// Key Vault Access (reference to existing Key Vault)
resource keyVault 'Microsoft.KeyVault/vaults@2023-07-01' existing = {
  name: '{{keyVaultAccess.vaultName}}'
  {{#if keyVaultAccess.resourceGroup}}
  scope: resourceGroup('{{keyVaultAccess.resourceGroup}}')
  {{/if}}
}

resource keyVaultAccessPolicy 'Microsoft.KeyVault/vaults/accessPolicies@2023-07-01' = {
  parent: keyVault
  name: 'add'
  properties: {
    accessPolicies: [
      {
        tenantId: subscription().tenantId
        objectId: managedIdentity.properties.principalId
        permissions: {
          {{#if keyVaultAccess.secrets}}
          secrets: [{{#each keyVaultAccess.secrets}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          {{/if}}
          {{#if keyVaultAccess.keys}}
          keys: [{{#each keyVaultAccess.keys}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          {{/if}}
          {{#if keyVaultAccess.certificates}}
          certificates: [{{#each keyVaultAccess.certificates}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          {{/if}}
        }
      }
    ]
  }
}
{{/if}}

// Outputs
output managedIdentityId string = enableManagedIdentity ? managedIdentity.id : ''
output managedIdentityName string = enableManagedIdentity ? managedIdentity.name : ''
output managedIdentityPrincipalId string = enableManagedIdentity ? managedIdentity.properties.principalId : ''
output managedIdentityClientId string = enableManagedIdentity ? managedIdentity.properties.clientId : ''
output managedIdentityTenantId string = enableManagedIdentity ? managedIdentity.properties.tenantId : ''
