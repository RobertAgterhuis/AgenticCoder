// Bicep Template: Azure Container App
// {{description}}
// Generated by AgenticCoder

@description('The name of the Container App')
param containerAppName string

@description('The location for the Container App')
param location string = resourceGroup().location

@description('The resource ID of the Container App Environment')
param containerAppEnvironmentId string

@description('The container image to deploy')
param containerImage string = '{{containerImage}}'

@description('The container registry server')
param containerRegistry string = '{{containerRegistry}}'

@description('Enable ingress for the Container App')
param enableIngress bool = {{enableIngress}}

@description('The target port for ingress')
param targetPort int = {{targetPort}}

@description('External ingress (public) or internal only')
param externalIngress bool = {{externalIngress}}

@description('Minimum number of replicas')
@minValue(0)
@maxValue(30)
param minReplicas int = {{minReplicas}}

@description('Maximum number of replicas')
@minValue(1)
@maxValue(30)
param maxReplicas int = {{maxReplicas}}

@description('CPU cores allocated to the container')
param cpu string = '{{cpu}}'

@description('Memory allocated to the container')
param memory string = '{{memory}}'

{{#if useRegistry}}
@description('Container registry username')
param registryUsername string

@description('Container registry password')
@secure()
param registryPassword string
{{/if}}

{{#if useManagedIdentity}}
@description('Enable user-assigned managed identity')
param userAssignedIdentityId string = ''
{{/if}}

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// Container App
resource containerApp 'Microsoft.App/containerApps@2023-05-01' = {
  name: containerAppName
  location: location
  tags: tags
  {{#if useManagedIdentity}}
  identity: {
    type: empty(userAssignedIdentityId) ? 'SystemAssigned' : 'UserAssigned'
    userAssignedIdentities: empty(userAssignedIdentityId) ? null : {
      '${userAssignedIdentityId}': {}
    }
  }
  {{/if}}
  properties: {
    managedEnvironmentId: containerAppEnvironmentId
    configuration: {
      {{#if useRegistry}}
      registries: [
        {
          server: containerRegistry
          username: registryUsername
          passwordSecretRef: 'registry-password'
        }
      ]
      secrets: [
        {
          name: 'registry-password'
          value: registryPassword
        }
        {{#each secrets}}
        {
          name: '{{name}}'
          value: '{{value}}'
        }
        {{/each}}
      ]
      {{/if}}
      activeRevisionsMode: '{{revisionsMode}}'
      ingress: enableIngress ? {
        external: externalIngress
        targetPort: targetPort
        transport: 'auto'
        allowInsecure: false
        traffic: [
          {
            weight: 100
            latestRevision: true
          }
        ]
        {{#if corsPolicy}}
        corsPolicy: {
          allowedOrigins: [{{#each corsPolicy.allowedOrigins}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          allowedMethods: [{{#each corsPolicy.allowedMethods}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          allowedHeaders: [{{#each corsPolicy.allowedHeaders}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          exposeHeaders: [{{#each corsPolicy.exposeHeaders}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
          maxAge: {{corsPolicy.maxAge}}
          allowCredentials: {{corsPolicy.allowCredentials}}
        }
        {{/if}}
      } : null
      {{#if dapr}}
      dapr: {
        enabled: true
        appId: '{{dapr.appId}}'
        appProtocol: '{{dapr.appProtocol}}'
        appPort: {{dapr.appPort}}
      }
      {{/if}}
    }
    template: {
      containers: [
        {
          image: containerImage
          name: containerAppName
          resources: {
            cpu: json(cpu)
            memory: memory
          }
          {{#if probes}}
          probes: [
            {{#if probes.liveness}}
            {
              type: 'Liveness'
              httpGet: {
                path: '{{probes.liveness.path}}'
                port: {{probes.liveness.port}}
              }
              initialDelaySeconds: {{probes.liveness.initialDelaySeconds}}
              periodSeconds: {{probes.liveness.periodSeconds}}
            }
            {{/if}}
            {{#if probes.readiness}}
            {
              type: 'Readiness'
              httpGet: {
                path: '{{probes.readiness.path}}'
                port: {{probes.readiness.port}}
              }
              initialDelaySeconds: {{probes.readiness.initialDelaySeconds}}
              periodSeconds: {{probes.readiness.periodSeconds}}
            }
            {{/if}}
          ]
          {{/if}}
          env: [
            {{#each envVars}}
            {
              name: '{{name}}'
              {{#if secretRef}}
              secretRef: '{{secretRef}}'
              {{else}}
              value: '{{value}}'
              {{/if}}
            }
            {{/each}}
          ]
          {{#if volumeMounts}}
          volumeMounts: [
            {{#each volumeMounts}}
            {
              volumeName: '{{volumeName}}'
              mountPath: '{{mountPath}}'
            }
            {{/each}}
          ]
          {{/if}}
        }
      ]
      scale: {
        minReplicas: minReplicas
        maxReplicas: maxReplicas
        {{#if scaleRules}}
        rules: [
          {{#each scaleRules}}
          {
            name: '{{name}}'
            {{#if http}}
            http: {
              metadata: {
                concurrentRequests: '{{http.concurrentRequests}}'
              }
            }
            {{/if}}
            {{#if custom}}
            custom: {
              type: '{{custom.type}}'
              metadata: {{custom.metadata}}
            }
            {{/if}}
          }
          {{/each}}
        ]
        {{/if}}
      }
      {{#if volumes}}
      volumes: [
        {{#each volumes}}
        {
          name: '{{name}}'
          storageType: '{{storageType}}'
          storageName: '{{storageName}}'
        }
        {{/each}}
      ]
      {{/if}}
    }
  }
}

// Outputs
output containerAppId string = containerApp.id
output containerAppName string = containerApp.name
output containerAppFqdn string = enableIngress ? containerApp.properties.configuration.ingress.fqdn : ''
output containerAppLatestRevision string = containerApp.properties.latestRevisionName
{{#if useManagedIdentity}}
output containerAppPrincipalId string = containerApp.identity.principalId
{{/if}}
