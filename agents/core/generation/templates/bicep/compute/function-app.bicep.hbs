// Bicep Template: Azure Function App
// {{description}}
// Generated by AgenticCoder

@description('The name of the Function App')
param functionAppName string

@description('The location for the Function App')
param location string = resourceGroup().location

@description('The pricing tier for the hosting plan')
@allowed([
  'Y1'
  'EP1'
  'EP2'
  'EP3'
  'P1v2'
  'P2v2'
  'P3v2'
])
param sku string = '{{sku}}'

@description('The runtime stack for the Function App')
@allowed([
  'dotnet'
  'dotnet-isolated'
  'node'
  'python'
  'java'
  'powershell'
])
param runtime string = '{{runtime}}'

@description('The runtime version')
param runtimeVersion string = '{{runtimeVersion}}'

@description('Enable Application Insights')
param enableAppInsights bool = {{enableAppInsights}}

@description('The resource ID of the App Service Plan (optional for consumption)')
param appServicePlanId string = ''

@description('The resource ID of the storage account')
param storageAccountId string

@description('The connection string for the storage account')
@secure()
param storageConnectionString string

{{#if useVnet}}
@description('The resource ID of the subnet for VNet integration')
param subnetId string
{{/if}}

{{#if useManagedIdentity}}
@description('Enable system-assigned managed identity')
param enableManagedIdentity bool = true
{{/if}}

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// Consumption plan (if not using existing plan)
resource hostingPlan 'Microsoft.Web/serverfarms@2022-09-01' = if (empty(appServicePlanId)) {
  name: '${functionAppName}-plan'
  location: location
  tags: tags
  sku: {
    name: sku
    tier: sku == 'Y1' ? 'Dynamic' : 'ElasticPremium'
  }
  properties: {
    reserved: runtime == 'python' || runtime == 'node'
  }
}

// Application Insights
resource appInsights 'Microsoft.Insights/components@2020-02-02' = if (enableAppInsights) {
  name: '${functionAppName}-insights'
  location: location
  tags: tags
  kind: 'web'
  properties: {
    Application_Type: 'web'
    Request_Source: 'rest'
    RetentionInDays: 90
    publicNetworkAccessForIngestion: 'Enabled'
    publicNetworkAccessForQuery: 'Enabled'
  }
}

// Function App
resource functionApp 'Microsoft.Web/sites@2022-09-01' = {
  name: functionAppName
  location: location
  tags: tags
  kind: 'functionapp{{#if useLinux}},linux{{/if}}'
  {{#if useManagedIdentity}}
  identity: {
    type: enableManagedIdentity ? 'SystemAssigned' : 'None'
  }
  {{/if}}
  properties: {
    serverFarmId: empty(appServicePlanId) ? hostingPlan.id : appServicePlanId
    httpsOnly: true
    {{#if useVnet}}
    virtualNetworkSubnetId: subnetId
    {{/if}}
    siteConfig: {
      {{#if useLinux}}
      linuxFxVersion: '${toUpper(runtime)}|${runtimeVersion}'
      {{else}}
      netFrameworkVersion: runtime == 'dotnet' ? 'v${runtimeVersion}' : null
      {{/if}}
      ftpsState: 'Disabled'
      minTlsVersion: '1.2'
      http20Enabled: true
      appSettings: [
        {
          name: 'AzureWebJobsStorage'
          value: storageConnectionString
        }
        {
          name: 'WEBSITE_CONTENTAZUREFILECONNECTIONSTRING'
          value: storageConnectionString
        }
        {
          name: 'WEBSITE_CONTENTSHARE'
          value: toLower(functionAppName)
        }
        {
          name: 'FUNCTIONS_EXTENSION_VERSION'
          value: '~4'
        }
        {
          name: 'FUNCTIONS_WORKER_RUNTIME'
          value: runtime
        }
        {{#if enableAppInsights}}
        {
          name: 'APPINSIGHTS_INSTRUMENTATIONKEY'
          value: enableAppInsights ? appInsights.properties.InstrumentationKey : ''
        }
        {
          name: 'APPLICATIONINSIGHTS_CONNECTION_STRING'
          value: enableAppInsights ? appInsights.properties.ConnectionString : ''
        }
        {{/if}}
        {{#each appSettings}}
        {
          name: '{{name}}'
          value: '{{value}}'
        }
        {{/each}}
      ]
    }
  }
}

{{#if useSlots}}
// Staging slot
resource stagingSlot 'Microsoft.Web/sites/slots@2022-09-01' = {
  parent: functionApp
  name: 'staging'
  location: location
  tags: tags
  kind: 'functionapp'
  properties: {
    serverFarmId: empty(appServicePlanId) ? hostingPlan.id : appServicePlanId
  }
}
{{/if}}

// Outputs
output functionAppId string = functionApp.id
output functionAppName string = functionApp.name
output functionAppDefaultHostname string = functionApp.properties.defaultHostName
{{#if useManagedIdentity}}
output functionAppPrincipalId string = functionApp.identity.principalId
{{/if}}
{{#if enableAppInsights}}
output appInsightsInstrumentationKey string = appInsights.properties.InstrumentationKey
output appInsightsConnectionString string = appInsights.properties.ConnectionString
{{/if}}
