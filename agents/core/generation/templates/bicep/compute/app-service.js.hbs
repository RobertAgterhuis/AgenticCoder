/**
 * Bicep App Service Template
 * 
 * Azure App Service / Web App deployment template
 */

const template = `// Azure App Service
// Generated by AgenticCoder

targetScope = 'resourceGroup'

// ============================================================================
// Parameters
// ============================================================================

@description('The name of the App Service')
@minLength(2)
@maxLength(60)
param appName string

@description('Location for all resources')
param location string = resourceGroup().location

@description('The pricing tier for the App Service Plan')
@allowed([
  'F1'
  'D1'
  'B1'
  'B2'
  'B3'
  'S1'
  'S2'
  'S3'
  'P1v2'
  'P2v2'
  'P3v2'
  'P1v3'
  'P2v3'
  'P3v3'
])
param sku string = '{{defaultSku}}'

@description('Runtime stack')
@allowed([
  'DOTNETCORE|8.0'
  'DOTNETCORE|7.0'
  'NODE|20-lts'
  'NODE|18-lts'
  'PYTHON|3.12'
  'PYTHON|3.11'
  'JAVA|17-java17'
])
param runtimeStack string = '{{defaultRuntime}}'

@description('Enable Application Insights')
param enableAppInsights bool = true

@description('Application Insights resource ID (required if enableAppInsights is true)')
param appInsightsId string = ''

@description('Tags for all resources')
param tags object = {}

@description('Enable Always On')
param alwaysOn bool = true

@description('Enable HTTPS only')
param httpsOnly bool = true

// ============================================================================
// Variables
// ============================================================================

var appServicePlanName = 'asp-\${appName}'
var webAppName = 'app-\${appName}'
var commonTags = union(tags, {
  'managed-by': 'bicep'
  'created-date': utcNow('yyyy-MM-dd')
})

// ============================================================================
// Resources
// ============================================================================

// App Service Plan
resource appServicePlan 'Microsoft.Web/serverfarms@2023-01-01' = {
  name: appServicePlanName
  location: location
  tags: commonTags
  sku: {
    name: sku
  }
  kind: 'linux'
  properties: {
    reserved: true
  }
}

// Web App
resource webApp 'Microsoft.Web/sites@2023-01-01' = {
  name: webAppName
  location: location
  tags: commonTags
  kind: 'app,linux'
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    serverFarmId: appServicePlan.id
    httpsOnly: httpsOnly
    siteConfig: {
      linuxFxVersion: runtimeStack
      alwaysOn: alwaysOn
      ftpsState: 'Disabled'
      minTlsVersion: '1.2'
      http20Enabled: true
      appSettings: concat([
        {
          name: 'WEBSITE_NODE_DEFAULT_VERSION'
          value: '~18'
        }
      ], enableAppInsights ? [
        {
          name: 'APPLICATIONINSIGHTS_CONNECTION_STRING'
          value: reference(appInsightsId, '2020-02-02').ConnectionString
        }
        {
          name: 'ApplicationInsightsAgent_EXTENSION_VERSION'
          value: '~3'
        }
      ] : [])
    }
  }
}

// Deployment Slots (staging)
{{#if enableStagingSlot}}
resource stagingSlot 'Microsoft.Web/sites/slots@2023-01-01' = {
  parent: webApp
  name: 'staging'
  location: location
  tags: commonTags
  kind: 'app,linux'
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    serverFarmId: appServicePlan.id
    httpsOnly: httpsOnly
    siteConfig: {
      linuxFxVersion: runtimeStack
      alwaysOn: alwaysOn
      autoSwapSlotName: 'production'
    }
  }
}
{{/if}}

// ============================================================================
// Outputs
// ============================================================================

@description('The name of the App Service')
output appServiceName string = webApp.name

@description('The default hostname of the App Service')
output defaultHostname string = webApp.properties.defaultHostName

@description('The URL of the App Service')
output appUrl string = 'https://\${webApp.properties.defaultHostName}'

@description('The principal ID of the App Service managed identity')
output principalId string = webApp.identity.principalId

@description('The resource ID of the App Service')
output resourceId string = webApp.id

@description('The App Service Plan resource ID')
output appServicePlanId string = appServicePlan.id
`;

/**
 * Prepare variables for App Service template
 */
function prepareVariables(config) {
  return {
    defaultSku: config.sku || 'B1',
    defaultRuntime: config.runtime || 'NODE|18-lts',
    enableStagingSlot: config.enableStagingSlot || false
  };
}

module.exports = {
  template,
  prepareVariables
};
