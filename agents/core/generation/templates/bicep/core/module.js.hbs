/**
 * Bicep Module Template
 * 
 * Base template for Azure Bicep modules following AVM patterns
 */

const template = `{{#if description}}// {{description}}
{{/if}}// Generated by AgenticCoder - Azure Bicep Template

targetScope = '{{targetScope}}'

// ============================================================================
// Parameters
// ============================================================================

{{#each parameters}}
@description('{{this.description}}')
{{#if this.allowed}}@allowed([
{{#each this.allowed}}
  '{{this}}'
{{/each}}
])
{{/if}}{{#if this.minLength}}@minLength({{this.minLength}})
{{/if}}{{#if this.maxLength}}@maxLength({{this.maxLength}})
{{/if}}{{#if this.minValue}}@minValue({{this.minValue}})
{{/if}}{{#if this.maxValue}}@maxValue({{this.maxValue}})
{{/if}}param {{this.name}} {{this.type}}{{#if this.hasDefault}} = {{this.default}}{{/if}}

{{/each}}

// ============================================================================
// Variables
// ============================================================================

{{#each variables}}
var {{this.name}} = {{this.value}}
{{/each}}

// ============================================================================
// Resources
// ============================================================================

{{#each resources}}
{{#if this.description}}// {{this.description}}
{{/if}}resource {{this.symbolicName}} '{{this.type}}@{{this.apiVersion}}' = {
  name: {{this.name}}
{{#if this.location}}
  location: {{this.location}}
{{/if}}
{{#if this.parent}}
  parent: {{this.parent}}
{{/if}}
{{#if this.scope}}
  scope: {{this.scope}}
{{/if}}
{{#if this.tags}}
  tags: {{this.tags}}
{{/if}}
{{#if this.sku}}
  sku: {
{{#each this.sku}}
    {{this.key}}: {{this.value}}
{{/each}}
  }
{{/if}}
{{#if this.kind}}
  kind: {{this.kind}}
{{/if}}
{{#if this.identity}}
  identity: {
    type: '{{this.identity.type}}'
{{#if this.identity.userAssignedIdentities}}
    userAssignedIdentities: {{this.identity.userAssignedIdentities}}
{{/if}}
  }
{{/if}}
  properties: {
{{#each this.properties}}
    {{this.key}}: {{this.value}}
{{/each}}
  }
{{#if this.dependsOn}}
  dependsOn: [
{{#each this.dependsOn}}
    {{this}}
{{/each}}
  ]
{{/if}}
}

{{/each}}

// ============================================================================
// Outputs
// ============================================================================

{{#each outputs}}
@description('{{this.description}}')
output {{this.name}} {{this.type}} = {{this.value}}
{{/each}}
`;

/**
 * Prepare variables for Bicep module generation
 */
function prepareVariables(config) {
  return {
    description: config.description || '',
    targetScope: config.targetScope || 'resourceGroup',
    parameters: (config.parameters || []).map(p => ({
      ...p,
      hasDefault: p.default !== undefined
    })),
    variables: config.variables || [],
    resources: config.resources || [],
    outputs: config.outputs || []
  };
}

module.exports = {
  template,
  prepareVariables
};
