// Main Bicep Template: {{projectName}}
// {{description}}
// Generated by AgenticCoder

targetScope = '{{targetScope}}'

// ============================================
// Parameters
// ============================================

@description('Environment name')
@allowed([
  'dev'
  'staging'
  'prod'
])
param environment string = '{{environment}}'

@description('Azure region for resources')
param location string = '{{location}}'

@description('Project name prefix for resources')
@minLength(3)
@maxLength(11)
param projectName string = '{{projectName}}'

@description('Tags to apply to all resources')
param tags object = {
  environment: environment
  project: projectName
  generatedBy: 'AgenticCoder'
  deployedAt: utcNow('yyyy-MM-dd')
}

{{#each parameters}}
@description('{{description}}')
{{#if allowed}}
@allowed([
{{#each allowed}}
  '{{this}}'
{{/each}}
])
{{/if}}
{{#if minLength}}@minLength({{minLength}}){{/if}}
{{#if maxLength}}@maxLength({{maxLength}}){{/if}}
{{#if minValue}}@minValue({{minValue}}){{/if}}
{{#if maxValue}}@maxValue({{maxValue}}){{/if}}
{{#if secure}}@secure(){{/if}}
param {{name}} {{type}}{{#if defaultValue}} = {{defaultValue}}{{/if}}

{{/each}}

// ============================================
// Variables
// ============================================

var resourcePrefix = '${projectName}-${environment}'
var resourcePrefixClean = replace(resourcePrefix, '-', '')

{{#each variables}}
var {{name}} = {{value}}
{{/each}}

// ============================================
// Modules
// ============================================

{{#each modules}}
// Module: {{name}}
module {{camelCase name}} '{{path}}' = {
  name: '{{name}}-deployment'
  {{#if scope}}
  scope: {{scope}}
  {{/if}}
  params: {
    location: location
    tags: tags
    {{#each params}}
    {{name}}: {{value}}
    {{/each}}
  }
  {{#if dependsOn}}
  dependsOn: [
    {{#each dependsOn}}
    {{this}}
    {{/each}}
  ]
  {{/if}}
}

{{/each}}

{{#if resources}}
// ============================================
// Resources (inline)
// ============================================

{{#each resources}}
resource {{symbolicName}} '{{type}}@{{apiVersion}}' = {
  name: {{name}}
  location: {{#if location}}{{location}}{{else}}location{{/if}}
  tags: tags
  {{#if kind}}
  kind: '{{kind}}'
  {{/if}}
  {{#if sku}}
  sku: {
    name: '{{sku.name}}'
    {{#if sku.tier}}tier: '{{sku.tier}}'{{/if}}
    {{#if sku.capacity}}capacity: {{sku.capacity}}{{/if}}
  }
  {{/if}}
  {{#if identity}}
  identity: {
    type: '{{identity.type}}'
  }
  {{/if}}
  properties: {
    {{#each properties}}
    {{key}}: {{value}}
    {{/each}}
  }
  {{#if dependsOn}}
  dependsOn: [
    {{#each dependsOn}}
    {{this}}
    {{/each}}
  ]
  {{/if}}
}

{{/each}}
{{/if}}

// ============================================
// Outputs
// ============================================

{{#each outputs}}
@description('{{description}}')
output {{name}} {{type}} = {{value}}

{{/each}}
