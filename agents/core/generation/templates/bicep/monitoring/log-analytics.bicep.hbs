// Bicep Template: Azure Log Analytics Workspace
// {{description}}
// Generated by AgenticCoder

@description('The name of the Log Analytics Workspace')
param workspaceName string

@description('The location for the workspace')
param location string = resourceGroup().location

@description('The SKU for the workspace')
@allowed([
  'Free'
  'Standalone'
  'PerNode'
  'PerGB2018'
  'Premium'
  'CapacityReservation'
])
param sku string = '{{sku}}'

@description('Data retention in days')
@minValue(30)
@maxValue(730)
param retentionInDays int = {{retentionInDays}}

@description('Daily quota for data ingestion in GB (-1 for unlimited)')
param dailyQuotaGb int = {{dailyQuotaGb}}

@description('Enable public network access')
param publicNetworkAccessForIngestion string = '{{publicNetworkAccessForIngestion}}'

@description('Enable public network access for query')
param publicNetworkAccessForQuery string = '{{publicNetworkAccessForQuery}}'

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// Log Analytics Workspace
resource workspace 'Microsoft.OperationalInsights/workspaces@2022-10-01' = {
  name: workspaceName
  location: location
  tags: tags
  properties: {
    sku: {
      name: sku
      {{#if capacityReservationLevel}}
      capacityReservationLevel: {{capacityReservationLevel}}
      {{/if}}
    }
    retentionInDays: retentionInDays
    {{#if dailyQuotaGb}}
    workspaceCapping: {
      dailyQuotaGb: dailyQuotaGb == -1 ? null : dailyQuotaGb
    }
    {{/if}}
    publicNetworkAccessForIngestion: publicNetworkAccessForIngestion
    publicNetworkAccessForQuery: publicNetworkAccessForQuery
    features: {
      enableLogAccessUsingOnlyResourcePermissions: true
      {{#if enableDataExport}}
      enableDataExport: {{enableDataExport}}
      {{/if}}
    }
  }
}

{{#if solutions}}
// Log Analytics Solutions
{{#each solutions}}
resource solution_{{@index}} 'Microsoft.OperationsManagement/solutions@2015-11-01-preview' = {
  name: '{{name}}(${workspace.name})'
  location: location
  tags: tags
  plan: {
    name: '{{name}}(${workspace.name})'
    publisher: 'Microsoft'
    product: 'OMSGallery/{{name}}'
    promotionCode: ''
  }
  properties: {
    workspaceResourceId: workspace.id
  }
}

{{/each}}
{{/if}}

{{#if dataSources}}
// Data Sources
{{#each dataSources}}
{{#if (eq kind 'WindowsEvent')}}
resource dataSource_{{@index}} 'Microsoft.OperationalInsights/workspaces/dataSources@2020-08-01' = {
  parent: workspace
  name: '{{name}}'
  kind: 'WindowsEvent'
  properties: {
    eventLogName: '{{eventLogName}}'
    eventTypes: [
      {{#each eventTypes}}
      {
        eventType: '{{this}}'
      }
      {{/each}}
    ]
  }
}
{{/if}}
{{#if (eq kind 'WindowsPerformanceCounter')}}
resource dataSource_{{@index}} 'Microsoft.OperationalInsights/workspaces/dataSources@2020-08-01' = {
  parent: workspace
  name: '{{name}}'
  kind: 'WindowsPerformanceCounter'
  properties: {
    objectName: '{{objectName}}'
    instanceName: '{{instanceName}}'
    intervalSeconds: {{intervalSeconds}}
    counterName: '{{counterName}}'
  }
}
{{/if}}
{{#if (eq kind 'LinuxSyslog')}}
resource dataSource_{{@index}} 'Microsoft.OperationalInsights/workspaces/dataSources@2020-08-01' = {
  parent: workspace
  name: '{{name}}'
  kind: 'LinuxSyslog'
  properties: {
    syslogName: '{{syslogName}}'
    syslogSeverities: [
      {{#each syslogSeverities}}
      {
        severity: '{{this}}'
      }
      {{/each}}
    ]
  }
}
{{/if}}

{{/each}}
{{/if}}

{{#if savedSearches}}
// Saved Searches / Alerts
{{#each savedSearches}}
resource savedSearch_{{@index}} 'Microsoft.OperationalInsights/workspaces/savedSearches@2020-08-01' = {
  parent: workspace
  name: '{{name}}'
  properties: {
    etag: '*'
    category: '{{category}}'
    displayName: '{{displayName}}'
    query: '{{query}}'
    version: 2
    {{#if functionAlias}}
    functionAlias: '{{functionAlias}}'
    {{/if}}
    {{#if functionParameters}}
    functionParameters: '{{functionParameters}}'
    {{/if}}
  }
}

{{/each}}
{{/if}}

{{#if linkedStorageAccounts}}
// Linked Storage Accounts (for custom logs, alerts)
{{#each linkedStorageAccounts}}
resource linkedStorage_{{@index}} 'Microsoft.OperationalInsights/workspaces/linkedStorageAccounts@2020-08-01' = {
  parent: workspace
  name: '{{dataSourceType}}'
  properties: {
    storageAccountIds: [
      '{{storageAccountId}}'
    ]
  }
}

{{/each}}
{{/if}}

{{#if diagnosticSettings}}
// Diagnostic Settings for the Workspace itself
resource diagnosticSettings 'Microsoft.Insights/diagnosticSettings@2021-05-01-preview' = {
  name: '${workspaceName}-diagnostics'
  scope: workspace
  properties: {
    {{#if diagnosticSettings.storageAccountId}}
    storageAccountId: '{{diagnosticSettings.storageAccountId}}'
    {{/if}}
    logs: [
      {
        categoryGroup: 'allLogs'
        enabled: true
        retentionPolicy: {
          enabled: true
          days: {{diagnosticSettings.retentionDays}}
        }
      }
    ]
    metrics: [
      {
        category: 'AllMetrics'
        enabled: true
        retentionPolicy: {
          enabled: true
          days: {{diagnosticSettings.retentionDays}}
        }
      }
    ]
  }
}
{{/if}}

// Outputs
output workspaceId string = workspace.id
output workspaceName string = workspace.name
output workspaceCustomerId string = workspace.properties.customerId
output workspaceResourceId string = workspace.id
output primarySharedKey string = workspace.listKeys().primarySharedKey
output secondarySharedKey string = workspace.listKeys().secondarySharedKey
