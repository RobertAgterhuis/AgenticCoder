// Bicep Template: Azure Private Endpoint
// {{description}}
// Generated by AgenticCoder

@description('The name of the private endpoint')
param privateEndpointName string

@description('The location for the private endpoint')
param location string = resourceGroup().location

@description('The resource ID of the target service')
param targetServiceId string

@description('The group IDs (sub-resources) to connect to')
param groupIds array = ['{{groupId}}']

@description('The resource ID of the subnet for the private endpoint')
param subnetId string

@description('Enable private DNS zone integration')
param enablePrivateDnsZone bool = {{enablePrivateDnsZone}}

@description('The private DNS zone name')
param privateDnsZoneName string = '{{privateDnsZoneName}}'

@description('The resource ID of an existing private DNS zone (optional)')
param existingPrivateDnsZoneId string = ''

@description('The resource ID of the VNet for DNS zone link')
param vnetId string = ''

@description('Tags to apply to all resources')
param tags object = {
  environment: '{{environment}}'
  project: '{{projectName}}'
  generatedBy: 'AgenticCoder'
}

// Common private DNS zones for Azure services
var privateDnsZones = {
  blob: 'privatelink.blob.${environment().suffixes.storage}'
  file: 'privatelink.file.${environment().suffixes.storage}'
  queue: 'privatelink.queue.${environment().suffixes.storage}'
  table: 'privatelink.table.${environment().suffixes.storage}'
  web: 'privatelink.web.${environment().suffixes.storage}'
  dfs: 'privatelink.dfs.${environment().suffixes.storage}'
  sql: 'privatelink${environment().suffixes.sqlServerHostname}'
  cosmos: 'privatelink.documents.azure.com'
  cosmosdb_sql: 'privatelink.documents.azure.com'
  cosmosdb_mongodb: 'privatelink.mongo.cosmos.azure.com'
  cosmosdb_cassandra: 'privatelink.cassandra.cosmos.azure.com'
  cosmosdb_gremlin: 'privatelink.gremlin.cosmos.azure.com'
  cosmosdb_table: 'privatelink.table.cosmos.azure.com'
  keyvault: 'privatelink.vaultcore.azure.net'
  servicebus: 'privatelink.servicebus.windows.net'
  eventhub: 'privatelink.servicebus.windows.net'
  acr: 'privatelink.azurecr.io'
  aks: 'privatelink.${location}.azmk8s.io'
  webapp: 'privatelink.azurewebsites.net'
  function: 'privatelink.azurewebsites.net'
  signalr: 'privatelink.service.signalr.net'
  cognitiveservices: 'privatelink.cognitiveservices.azure.com'
  openai: 'privatelink.openai.azure.com'
}

// Private Endpoint
resource privateEndpoint 'Microsoft.Network/privateEndpoints@2023-04-01' = {
  name: privateEndpointName
  location: location
  tags: tags
  properties: {
    subnet: {
      id: subnetId
    }
    privateLinkServiceConnections: [
      {
        name: '${privateEndpointName}-plsc'
        properties: {
          privateLinkServiceId: targetServiceId
          groupIds: groupIds
          requestMessage: 'Auto-approved private endpoint connection'
        }
      }
    ]
    {{#if manualApproval}}
    manualPrivateLinkServiceConnections: [
      {
        name: '${privateEndpointName}-manual-plsc'
        properties: {
          privateLinkServiceId: targetServiceId
          groupIds: groupIds
          requestMessage: '{{approvalMessage}}'
        }
      }
    ]
    {{/if}}
    customNetworkInterfaceName: '${privateEndpointName}-nic'
  }
}

// Private DNS Zone (create new if not using existing)
resource privateDnsZone 'Microsoft.Network/privateDnsZones@2020-06-01' = if (enablePrivateDnsZone && empty(existingPrivateDnsZoneId)) {
  name: !empty(privateDnsZoneName) ? privateDnsZoneName : privateDnsZones[groupIds[0]]
  location: 'global'
  tags: tags
}

// VNet Link to Private DNS Zone
resource privateDnsZoneVnetLink 'Microsoft.Network/privateDnsZones/virtualNetworkLinks@2020-06-01' = if (enablePrivateDnsZone && !empty(vnetId)) {
  parent: empty(existingPrivateDnsZoneId) ? privateDnsZone : null
  name: '${privateEndpointName}-vnetlink'
  location: 'global'
  tags: tags
  properties: {
    registrationEnabled: false
    virtualNetwork: {
      id: vnetId
    }
  }
}

// DNS Zone Group (links private endpoint to DNS zone)
resource privateDnsZoneGroup 'Microsoft.Network/privateEndpoints/privateDnsZoneGroups@2023-04-01' = if (enablePrivateDnsZone) {
  parent: privateEndpoint
  name: 'default'
  properties: {
    privateDnsZoneConfigs: [
      {
        name: 'config1'
        properties: {
          privateDnsZoneId: !empty(existingPrivateDnsZoneId) ? existingPrivateDnsZoneId : privateDnsZone.id
        }
      }
    ]
  }
}

// Outputs
output privateEndpointId string = privateEndpoint.id
output privateEndpointName string = privateEndpoint.name
output privateEndpointNicId string = privateEndpoint.properties.networkInterfaces[0].id
output privateIpAddress string = privateEndpoint.properties.customDnsConfigs[0].ipAddresses[0]
output privateDnsZoneId string = enablePrivateDnsZone && empty(existingPrivateDnsZoneId) ? privateDnsZone.id : existingPrivateDnsZoneId
